<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Opera√ß√µes & Riscos ‚Äî Central de Ajuda</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Tailwind (CDN para teste/local). Para produ√ß√£o, use build com PostCSS. -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Quill -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    :root{--azul:#4737e6}
    .winbar{background:var(--azul)}
    .tab-on{background:#eef2ff;color:#4338ca}
    .card{box-shadow:0 10px 30px rgba(2,6,23,.08)}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.5rem;padding:.5rem .75rem;font-weight:600}
    .btn-ghost{border:1px solid #e5e7eb}
    .btn-primary{background:var(--azul);color:#fff}
    .btn-danger{background:#ef4444;color:#fff}
    .sidebar-btn{display:flex;width:100%;align-items:center;justify-content:space-between;gap:.5rem;padding:.75rem 1rem;border-radius:.75rem}
    .sidebar-item{display:block;padding:.6rem 1rem;border-radius:.6rem}
    .sidebar-item.active{background:#eef2ff;color:#4338ca}
    .thumb{max-height:260px;object-fit:contain}
    .modal-backdrop{background:rgba(0,0,0,.45)}
    .link{color:#4338ca}
    .topic-html h2{font-size:1.25rem;font-weight:700;margin-bottom:.25rem}
    .topic-html h3{font-weight:700;margin-top:1rem}
    .topic-html p{margin:.25rem 0}
    .topic-html ul{list-style:disc;margin-left:1.25rem}
    .sub-link{padding:.35rem 1rem .35rem 2rem; font-size:0.9rem}

    .quill-wrap { border:1px solid #e5e7eb; border-radius:.75rem; overflow:hidden; }
    .quill-toolbar { background:#fafafa; border-bottom:1px solid #e5e7eb; }
    .quill-editor { height: 11rem; }
    .ql-container.ql-snow { border:0; }
    .ql-toolbar.ql-snow { border:0; }

    .prose :where(code){ background:#f4f4f5; padding:.1rem .35rem; border-radius:.35rem; font-family:ui-monospace,Menlo,Consolas,monospace;}
    .prose pre{ background:#0b1220; color:#e5e7eb; padding:1rem; border-radius:.5rem; overflow:auto; }
    .prose h1,.prose h2,.prose h3{ font-weight:700; }
    .prose img{ max-width:100%; height:auto; border-radius:.75rem; cursor: zoom-in; }
  </style>
</head>
<body class="bg-white text-gray-900">
  <header class="winbar text-white">
    <div class="max-w-7xl mx-auto h-14 px-4 sm:px-6 lg:px-8 flex items-center gap-3">
      <div class="h-6 w-6 rounded bg-white/90"></div>
      <div class="font-semibold">Opera√ß√µes & Riscos ‚Äî Central de Ajuda</div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <div class="flex flex-wrap gap-2 text-sm mb-4">
      <button class="px-3 py-2 rounded-lg tab-on" data-tab="content">Conte√∫do</button>
      <button class="px-3 py-2 rounded-lg hover:bg-gray-100" data-tab="index">√çndice</button>
      <button class="px-3 py-2 rounded-lg hover:bg-gray-100" data-tab="search">Pesquisar</button>
      <button class="px-3 py-2 rounded-lg hover:bg-gray-100" data-tab="favs">Favoritos</button>
      <button class="px-3 py-2 rounded-lg hover:bg-gray-100" data-tab="trash">Lixeira</button>
    </div>

    <!-- PAINEL: CONTE√öDO -->
    <section id="tab-content" class="grid grid-cols-12 gap-6">
      <!-- Sidebar -->
      <aside class="col-span-12 md:col-span-4 lg:col-span-3">
        <div class="space-y-3">

          <div class="border rounded-xl">
            <button class="sidebar-btn w-full font-medium hover:bg-gray-50" data-acc="intro">
              <span class="flex items-center gap-2">üìò Introdu√ß√£o</span>
              <span data-acc-icon="intro">‚ñº</span>
            </button>
            <div class="px-2 pb-3" id="acc-intro">
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="intro-sobre">‚Ä¢ Sobre esta central</a>
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="intro-visao">‚Ä¢ Gest√£o de Opera√ß√µes e Risco (vis√£o)</a>
            </div>
          </div>

          <div class="border rounded-xl">
            <button class="sidebar-btn w-full font-medium hover:bg-gray-50" data-acc="cad">
              <span class="flex items-center gap-2">üìÇ Cadastro & Contas</span>
              <span data-acc-icon="cad">‚ñº</span>
            </button>
            <div class="px-2 pb-3" id="acc-cad">
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="credenciamento">Credenciamento</a>
              <div class="pl-2" data-subs-for="credenciamento"></div>
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="descredenciamento">Descredenciamento</a>
              <div class="pl-2" data-subs-for="descredenciamento"></div>
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="kyc">1¬™ Venda (KYC)</a>
              <div class="pl-2" data-subs-for="kyc"></div>
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="movimentacoes">Movimenta√ß√µes</a>
              <div class="pl-2" data-subs-for="movimentacoes"></div>
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="investigacoes">Investiga√ß√µes</a>
              <div class="pl-2" data-subs-for="investigacoes"></div>
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="recebiveis">Receb√≠veis</a>
              <div class="pl-2" data-subs-for="recebiveis"></div>
            </div>
          </div>

          <div class="border rounded-xl">
            <button class="sidebar-btn w-full font-medium hover:bg-gray-50" data-acc="inter">
              <span class="flex items-center gap-2">üîÅ Interc√¢mbio</span>
              <span data-acc-icon="inter">‚ñº</span>
            </button>
            <div class="px-2 pb-3" id="acc-inter">
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="disputa">Disputa</a>
              <div class="pl-2" data-subs-for="disputa"></div>
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="chargeback">Chargeback</a>
              <div class="pl-2" data-subs-for="chargeback"></div>
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="recuperacao">Recupera√ß√£o</a>
              <div class="pl-2" data-subs-for="recuperacao"></div>
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="cobranca">Cobran√ßa</a>
              <div class="pl-2" data-subs-for="cobranca"></div>
            </div>
          </div>

          <div class="border rounded-xl">
            <button class="sidebar-btn w-full font-medium hover:bg-gray-50" data-acc="fraude">
              <span class="flex items-center gap-2">üõ°Ô∏è Preven√ß√£o √† Fraude</span>
              <span data-acc-icon="fraude">‚ñº</span>
            </button>
            <div class="px-2 pb-3" id="acc-fraude">
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="proc-analise">Processo de An√°lise</a>
              <div class="pl-2" data-subs-for="proc-analise"></div>
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="monitoramentos">Monitoramentos</a>
              <div class="pl-2" data-subs-for="monitoramentos"></div>
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="alertas-pos">Alertas POS</a>
              <div class="pl-2" data-subs-for="alertas-pos"></div>
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="fraude-recebiveis">Receb√≠veis</a>
              <div class="pl-2" data-subs-for="fraude-recebiveis"></div>

              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="med-qitech">MED</a>
              <div class="pl-2" data-subs-for="med-qitech"></div>
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="med-qitech">Qitech</a>
              <div class="pl-2" data-subs-for="med-qitech"></div>

              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="boleto">Boleto</a>
              <div class="pl-2" data-subs-for="boleto"></div>
            </div>
          </div>

          <div class="border rounded-xl">
            <button class="sidebar-btn w-full font-medium hover:bg-gray-50" data-acc="ctrl">
              <span class="flex items-center gap-2">‚öôÔ∏è Controles & Processos</span>
              <span data-acc-icon="ctrl">‚ñº</span>
            </button>
            <div class="px-2 pb-3" id="acc-ctrl">
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="ctrl-visao">Vis√£o geral</a>
              <div class="pl-2" data-subs-for="ctrl-visao"></div>
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="estruturas-dados">Estruturas de dados</a>
              <div class="pl-2" data-subs-for="estruturas-dados"></div>
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="modelagens-automacoes">Modelagens e automa√ß√µes</a>
              <div class="pl-2" data-subs-for="modelagens-automacoes"></div>
            </div>
          </div>

          <div class="border rounded-xl">
            <button class="sidebar-btn w-full font-medium hover:bg-gray-50" data-acc="times">
              <span class="flex items-center gap-2">üë• Times & Opera√ß√£o</span>
              <span data-acc-icon="times">‚ñº</span>
            </button>
            <div class="px-2 pb-3" id="acc-times">
              <a class="sidebar-item hover:bg-gray-50" href="#" data-topic="ausencias">Aus√™ncias & Backups</a>
              <div class="pl-2" data-subs-for="ausencias"></div>
            </div>
          </div>

        </div>
      </aside>

      <!-- Coluna principal -->
      <section class="col-span-12 md:col-span-8 lg:col-span-9">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div>
            <h1 id="topicTitle" class="text-xl font-semibold">Credenciamento</h1>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-ghost" id="btnFav">‚òÜ Favoritar t√≥pico</button>
            <button class="btn btn-primary" id="btnAdd">+ Adicionar guia</button>
          </div>
        </div>

        <div class="border-b my-3"></div>

        <p id="topicDesc" class="text-gray-700 mb-6">Credenciamento ‚Äî Cria√ß√£o/ativa√ß√£o de conta.</p>

        <div id="topicHtml" class="topic-html hidden mb-8"></div>

        <h2 id="guidesTitle" class="text-lg font-semibold mb-3">Guias da equipe</h2>
        <div id="guides" class="space-y-4"></div>

        <p class="text-xs text-gray-500 mt-6">
          Atalho: pressione <b>S</b> para editar subt√≠tulos do t√≥pico atual.
        </p>
      </section>
    </section>

    <!-- PAINEL: √çNDICE -->
    <section id="tab-index" class="hidden">
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="border rounded-xl p-4">
          <div class="font-semibold mb-2">üìò Introdu√ß√£o</div>
          <ul class="space-y-1">
            <li><a class="link hover:underline" data-jump="intro-sobre">Sobre esta central</a></li>
            <li><a class="link hover:underline" data-jump="intro-visao">Gest√£o de Opera√ß√µes e Risco (vis√£o)</a></li>
          </ul>
        </div>
        <div class="border rounded-xl p-4">
          <div class="font-semibold mb-2">üìÇ Cadastro & Contas</div>
          <ul class="space-y-1">
            <li><a class="link hover:underline" data-jump="credenciamento">Credenciamento</a></li>
            <li><a class="link hover:underline" data-jump="descredenciamento">Descredenciamento</a></li>
            <li><a class="link hover:underline" data-jump="kyc">1¬™ Venda (KYC)</a></li>
            <li><a class="link hover:underline" data-jump="movimentacoes">Movimenta√ß√µes</a></li>
            <li><a class="link hover:underline" data-jump="investigacoes">Investiga√ß√µes</a></li>
            <li><a class="link hover:underline" data-jump="recebiveis">Receb√≠veis</a></li>
          </ul>
        </div>
        <div class="border rounded-xl p-4">
          <div class="font-semibold mb-2">üîÅ Interc√¢mbio</div>
          <ul class="space-y-1">
            <li><a class="link hover:underline" data-jump="disputa">Disputa</a></li>
            <li><a class="link hover:underline" data-jump="chargeback">Chargeback</a></li>
            <li><a class="link hover:underline" data-jump="recuperacao">Recupera√ß√£o</a></li>
            <li><a class="link hover:underline" data-jump="cobranca">Cobran√ßa</a></li>
          </ul>
        </div>
        <div class="border rounded-xl p-4">
          <div class="font-semibold mb-2">üõ°Ô∏è Preven√ß√£o √† Fraude</div>
          <ul class="space-y-1">
            <li><a class="link hover:underline" data-jump="proc-analise">Processo de An√°lise</a></li>
            <li><a class="link hover:underline" data-jump="monitoramentos">Monitoramentos</a></li>
            <li><a class="link hover:underline" data-jump="alertas-pos">Alertas POS</a></li>
            <li><a class="link hover:underline" data-jump="fraude-recebiveis">Receb√≠veis (Fraude)</a></li>
            <li><a class="link hover:underline" data-jump="med-qitech">MED Qitech</a></li>
            <li><a class="link hover:underline" data-jump="boleto">Boleto</a></li>
          </ul>
        </div>
        <div class="border rounded-xl p-4">
          <div class="font-semibold mb-2">‚öôÔ∏è Controles & Processos</div>
          <ul class="space-y-1">
            <li><a class="link hover:underline" data-jump="ctrl-visao">Vis√£o geral</a></li>
            <li><a class="link hover:underline" data-jump="estruturas-dados">Estruturas de dados</a></li>
            <li><a class="link hover:underline" data-jump="modelagens-automacoes">Modelagens e automa√ß√µes</a></li>
          </ul>
        </div>
        <div class="border rounded-xl p-4">
          <div class="font-semibold mb-2">üë• Times & Opera√ß√£o</div>
          <ul class="space-y-1">
            <li><a class="link hover:underline" data-jump="ausencias">Aus√™ncias & Backups</a></li>
          </ul>
        </div>
      </div>
    </section>

    <!-- PAINEL: PESQUISAR -->
    <section id="tab-search" class="hidden">
      <div class="max-w-3xl">
        <div class="flex gap-2 mb-3">
          <input id="q" class="flex-1 border rounded-lg px-3 py-2" placeholder="Busque por t√≥pico, guia ou texto..." />
          <button id="doSearch" class="btn btn-primary">Buscar</button>
        </div>
        <div id="searchRes" class="space-y-3"></div>
      </div>
    </section>

    <!-- PAINEL: FAVORITOS -->
    <section id="tab-favs" class="hidden">
      <div id="favList" class="space-y-3"></div>
    </section>

    <!-- PAINEL: LIXEIRA -->
    <section id="tab-trash" class="hidden">
      <div class="max-w-3xl">
        <p class="text-sm text-gray-600 mb-3">
          Guias exclu√≠dos ficam aqui. Voc√™ pode restaurar ou apagar de vez.
        </p>
        <div class="flex gap-2 mb-3">
          <button id="btnPurgeTrash" class="btn btn-danger">Esvaziar lixeira</button>
          <button id="btnRefreshTrash" class="btn btn-ghost">Atualizar</button>
        </div>
        <div id="trashList" class="space-y-3"></div>
      </div>
    </section>
  </div>

  <!-- MODAL: Editor de Subt√≠tulos -->
  <div id="subModal" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-50">
    <div class="bg-white rounded-xl w-full max-w-2xl p-6 card relative max-h-[90vh] overflow-hidden">
      <button id="closeSub" class="absolute right-4 top-4 text-gray-500 hover:text-gray-700">‚úï</button>
      <h3 class="text-lg font-semibold mb-4">Subt√≠tulos de <span id="subTopicName"></span></h3>

      <form id="subForm" class="space-y-3 overflow-y-auto max-h-[70vh] pr-1">
        <div class="text-sm text-gray-600 -mt-2">Cada subt√≠tulo pode apontar para <b>qualquer guia</b> deste t√≥pico.</div>
        <div id="subList" class="space-y-3"></div>
        <div class="flex justify-between items-center pt-2">
          <button type="button" id="btnAddSubRow" class="btn btn-ghost">+ Adicionar subt√≠tulo</button>
          <button class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- TEMPLATE BARRA QUILL (COM IMAGEM) -->
  <template id="quill-toolbar-template">
    <div class="ql-toolbar ql-snow quill-toolbar px-2 py-1 flex flex-wrap gap-1">
      <select class="ql-header">
        <option value="1">H1</option>
        <option value="2">H2</option>
        <option value="3">H3</option>
        <option selected></option>
      </select>
      <button class="ql-bold"></button>
      <button class="ql-italic"></button>
      <button class="ql-underline"></button>
      <button class="ql-strike"></button>
      <span class="mx-1 w-px h-5 bg-gray-200"></span>
      <button class="ql-list" value="ordered"></button>
      <button class="ql-list" value="bullet"></button>
      <button class="ql-blockquote"></button>
      <button class="ql-code-block"></button>
      <span class="mx-1 w-px h-5 bg-gray-200"></span>
      <button class="ql-link"></button>
      <button class="ql-image"></button>
      <button class="ql-clean"></button>
    </div>
  </template>

  <!-- MODAL: Guia -->
  <div id="guideModal" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-50">
    <div class="bg-white rounded-xl w-full max-w-3xl p-6 card relative max-h-[90vh] overflow-hidden">
      <button id="closeGuide" class="absolute right-4 top-4 text-gray-500 hover:text-gray-700">‚úï</button>
      <h3 id="modalTitle" class="text-lg font-semibold mb-4">Adicionar guia</h3>

      <form id="guideForm" class="space-y-4 overflow-y-auto max-h-[80vh] pr-2">
        <div class="border rounded-xl p-3 bg-gray-50">
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="create_sub" class="h-4 w-4">
            <span class="font-medium">Criar tamb√©m um <em>subt√≠tulo</em> para este guia</span>
          </label>
          <div id="subFields" class="grid sm:grid-cols-2 gap-3 mt-3 hidden">
            <div>
              <label class="text-sm text-gray-600">T√≠tulo do subt√≠tulo</label>
              <input name="sub_title" class="w-full border rounded-lg px-3 py-2" placeholder="Use o mesmo t√≠tulo da guia ou personalize">
            </div>
            <div>
              <label class="text-sm text-gray-600">Descri√ß√£o (opcional)</label>
              <input name="sub_desc" class="w-full border rounded-lg px-3 py-2" placeholder="Breve descri√ß√£o do subt√≠tulo">
            </div>
          </div>
        </div>

        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-gray-600">T√≠tulo do guia</label>
            <input name="title" class="w-full border rounded-lg px-3 py-2" placeholder="Ex.: Valida√ß√£o credenciamento" required />
          </div>
          <div>
            <label class="text-sm text-gray-600">Autor(a)</label>
            <input name="author" class="w-full border rounded-lg px-3 py-2" placeholder="Seu nome" required />
          </div>
        </div>

        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-gray-600">Cargo/Atua√ß√£o</label>
            <input name="role" class="w-full border rounded-lg px-3 py-2" placeholder="Ex.: Analista ‚Äî Cadastro" />
          </div>
          <div>
            <label class="text-sm text-gray-600">Data de atualiza√ß√£o</label>
            <input name="updated" class="w-full border rounded-lg px-3 py-2" readonly />
          </div>
        </div>

        <div class="border-t pt-4">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-semibold">Passos do processo</h4>
            <button type="button" id="btnAddStep" class="btn btn-ghost">+ Adicionar passo</button>
          </div>
          <div id="stepsWrap" class="space-y-4 max-h-[350px] overflow-y-auto pr-2"></div>
        </div>

        <div class="flex items-center justify-between pt-2">
          <span class="text-xs text-gray-500">Imagens ficam dentro da <b>Descri√ß√£o</b> (bot√£o üñºÔ∏è), ent√£o no editar elas continuam l√°.</span>
          <div class="flex gap-2">
            <button type="button" id="btnDeleteGuide" class="btn btn-danger hidden">Excluir guia</button>
            <button class="btn btn-primary" type="submit">Salvar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL: Visualizar Imagem -->
  <div id="imgModal" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-50">
    <div class="bg-white rounded-xl p-2 max-w-3xl w-[95%] card relative">
      <button id="closeImg" class="absolute right-3 top-3 text-gray-500 hover:text-gray-700">‚úï</button>
      <img id="imgViewer" class="w-full h-[70vh] object-contain rounded-lg" src="" alt="Imagem do passo" />
    </div>
  </div>

  <!-- MODAL: Gerenciar atividades -->
  <div id="actModal" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-50">
    <div class="bg-white rounded-xl w-full max-w-2xl p-6 card relative max-h-[90vh] overflow-hidden">
      <button id="closeAct" class="absolute right-4 top-4 text-gray-500 hover:text-gray-700">‚úï</button>
      <h3 class="text-lg font-semibold mb-3">Gerenciar atividades</h3>
      <p class="text-sm text-gray-600 mb-3">Renomeie ou exclua atividades que voc√™ adicionou. As padr√£o ficam bloqueadas.</p>
      <div id="actList" class="space-y-2 overflow-y-auto max-h-[65vh] pr-1"></div>
    </div>
  </div>

  <script>
    /* ===== Polyfills/Helpers ===== */
    function uuid() {
      try { if (window.crypto && crypto.randomUUID) return crypto.randomUUID(); } catch (e) {}
      return 'id-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    }
    if (typeof window.CSS === 'undefined') window.CSS = {};
    if (typeof window.CSS.escape !== 'function') {
      window.CSS.escape = function (s) { return String(s).replace(/[^a-zA-Z0-9_\\-]/g, '\\\\$&'); };
    }
    const $  = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>[...p.querySelectorAll(s)];
    const nowFmt = ()=>new Date().toLocaleString('pt-BR');
    const openModal=(el,v)=>{el.classList.toggle('hidden',!v);el.classList.toggle('flex',v);};

    // N√£o normalize base64 (data:) nem blob:
    const normalizeUrl = u => {
      u = (u||'').trim();
      if (!u) return '';
      if (/^(data:|blob:)/i.test(u)) return u;
      if (!/^https?:\/\//i.test(u)) u = 'https://' + u;
      return u;
    };
    const parseLinks = raw =>
      (raw||'')
        .split(/\r?\n|,|;/)
        .map(v=>normalizeUrl(v))
        .filter(v=>v && /^https?:\/\//i.test(v));

    /* ====== T√≥picos ====== */
    const TOPICS = {
      'intro-sobre': { title:'Sobre esta central', desc:'', html:'<h2>Bem-vindo üëã</h2><p>Use <b>Favoritos</b> para marcar o que voc√™ consulta com frequ√™ncia.</p><p>Dica: nas guias, insira imagens direto na descri√ß√£o (üñºÔ∏è) para elas n√£o sumirem ao editar.</p>' },
      'intro-visao': { title:'Gest√£o de Opera√ß√µes e Risco ‚Äî vis√£o', desc:'', html:'<h2>Vis√£o concentrada</h2><p>Menu em √°rvore √† esquerda e leitura √† direita.</p>' },
      credenciamento:{title:'Credenciamento',desc:'Credenciamento ‚Äî Cria√ß√£o/ativa√ß√£o de conta, gateways, adquirentes, VP.'},
      descredenciamento:{title:'Descredenciamento',desc:'Encerramento/ajustes de contas e adequa√ß√µes.'},
      kyc:{title:'1¬™ Venda (KYC)',desc:'An√°lise do modelo de neg√≥cio e risco.'},
      movimentacoes:{title:'Movimenta√ß√µes',desc:'Saque, antecipa√ß√µes e transfer√™ncias.'},
      investigacoes:{title:'Investiga√ß√µes',desc:'Monitoramento e abertura de investiga√ß√£o.'},
      recebiveis:{title:'Receb√≠veis',desc:'Parametriza√ß√£o e libera√ß√£o mediante evid√™ncias.'},
      disputa:{title:'Disputa',desc:'Bloqueio tempor√°rio e decis√£o por evid√™ncias.'},
      chargeback:{title:'Chargeback',desc:'Defesa junto √†s adquirentes.'},
      recuperacao:{title:'Recupera√ß√£o',desc:'Revers√µes e contato ativo.'},
      cobranca:{title:'Cobran√ßa',desc:'Gest√£o de saldo negativo.'},
      'proc-analise':{title:'Processo de An√°lise',desc:'Antifraude, manual e monitoramentos.'},
      monitoramentos:{title:'Monitoramentos',desc:'Alertas e anomalias.'},
      'alertas-pos':{title:'Alertas POS',desc:'Cen√°rios de risco e bloqueios.'},
      'fraude-recebiveis':{title:'Receb√≠veis (Fraude)',desc:'Bloqueio at√© comprova√ß√£o da venda.'},
      'med-qitech':{title:'MED Qitech',desc:'Conte√∫dos e guias sobre MED Qitech.'},
      'boleto':{title:'Boleto',desc:'Conte√∫dos e guias sobre Boleto.'},
      'ctrl-visao':{title:'Controles & Processos ‚Äî Vis√£o',desc:'Acompanhamento e indicadores.'},
      'estruturas-dados':{title:'Estruturas de dados',desc:'Dicion√°rios e schemas.'},
      'modelagens-automacoes':{title:'Modelagens e automa√ß√µes de processos',desc:'Fluxos e integra√ß√µes.'},
      ausencias:{
        title:'Aus√™ncias & Backups',
        desc:'',
        html: `
          <h2 class="text-lg font-semibold mb-2">Cadastro de Aus√™ncias & Backups</h2>
          <p class="text-gray-600 mb-3">Registre a pessoa principal, o(s) backup(s), atividades cobertas e o per√≠odo de aus√™ncia.</p>

          <form id="absForm" class="border rounded-xl p-4 space-y-4 bg-gray-50">
            <div class="grid sm:grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-gray-600">Pessoa principal</label>
                <input id="absPrincipal" class="w-full border rounded-lg px-3 py-2" placeholder="Ex.: Maria Silva" />
              </div>
              <div>
                <label class="text-sm text-gray-600">Backup(s)</label>
                <input id="absBackups" class="w-full border rounded-lg px-3 py-2" placeholder="Ex.: Jo√£o Souza; Ana Lima" />
              </div>
            </div>

            <div class="grid sm:grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-gray-600">In√≠cio</label>
                <input id="absStart" type="date" class="w-full border rounded-lg px-3 py-2"/>
              </div>
              <div>
                <label class="text-sm text-gray-600">Fim</label>
                <input id="absEnd" type="date" class="w-full border rounded-lg px-3 py-2"/>
              </div>
            </div>

            <div>
              <label class="text-sm text-gray-600">Atividades cobertas</label>
              <div id="absActs" class="flex flex-wrap gap-2 mt-2"></div>

              <div class="flex flex-wrap itens-center gap-2 mt-3">
                <input id="absNewAct" class="flex-1 min-w-[240px] border rounded-lg px-3 py-2" placeholder="Adicionar atividade (ex.: Neoway)" />
                <button id="absAddAct" type="button" class="btn btn-ghost">+ Adicionar</button>
                <button id="absManageAct" type="button" class="btn btn-ghost">‚öôÔ∏è Gerenciar atividades</button>
              </div>
              <p class="text-xs text-gray-500 mt-1">Marque o que a pessoa principal faz e o backup tamb√©m consegue cobrir.</p>
            </div>

            <div class="flex justify-end gap-2">
              <button class="btn btn-ghost hidden" id="absCancelEdit" type="button">Cancelar edi√ß√£o</button>
              <button class="btn btn-primary" id="absSave">Salvar</button>
            </div>
          </form>

          <div class="mt-4">
            <h3 class="font-semibold mb-2">Registros</h3>
            <div id="absList" class="space-y-2"></div>
          </div>
        `
      }
    };

    /* ===== Backend compartilhado (Worker + KV) ===== */
    const API_URL = 'https://central-ajuda-api.vitoria-leite.workers.dev/db';

    const STATE = {
      guides: [],
      subs: {},
      absences: [],
      acts: [],
      deletedGuides: []
    };

    function applyRemoteState(data) {
      if (!data || typeof data !== 'object') return;
      STATE.guides        = Array.isArray(data.guides)        ? data.guides        : [];
      STATE.subs          = data.subs || {};
      STATE.absences      = Array.isArray(data.absences)      ? data.absences      : [];
      STATE.acts          = Array.isArray(data.acts)          ? data.acts          : [];
      STATE.deletedGuides = Array.isArray(data.deletedGuides) ? data.deletedGuides : [];
    }

    let __saveTimer = null;

    function scheduleSaveRemote() {
      if (__saveTimer) clearTimeout(__saveTimer);
      __saveTimer = setTimeout(doSaveRemote, 250); // debounce evita corrida (race)
    }

    function doSaveRemote() {
      __saveTimer = null;
      const payload = {
        guides:        STATE.guides        || [],
        subs:          STATE.subs          || {},
        absences:      STATE.absences      || [],
        acts:          STATE.acts          || [],
        deletedGuides: STATE.deletedGuides || []
      };
      fetch(API_URL, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).catch(err => console.error('Erro salvando base remota', err));
    }

    async function loadRemote() {
      try {
        const res = await fetch(API_URL);
        if (res.ok) {
          const data = await res.json();
          applyRemoteState(data);
        } else {
          console.warn('Erro HTTP ao carregar base remota', res.status);
        }
      } catch (e) {
        console.warn('N√£o foi poss√≠vel carregar base remota (usando vazio)', e);
      }
      cleanupOrphanSubtitles();
      renderTopic();
      renderSubsInSidebar();
    }

    /* ===== Storage (STATE) ===== */
    const readDB    = () => STATE.guides   || [];
    const writeDB   = a  => { STATE.guides   = a || []; scheduleSaveRemote(); };
    const readSubs  = () => STATE.subs     || {};
    const writeSubs = v  => { STATE.subs     = v || {}; scheduleSaveRemote(); };
    const readAbs   = () => STATE.absences || [];
    const writeAbs  = v  => { STATE.absences = v || []; scheduleSaveRemote(); };
    const getSavedActs = () => STATE.acts || [];
    const writeActs    = arr => { STATE.acts = arr || []; scheduleSaveRemote(); };
    const readTrash  = () => STATE.deletedGuides || [];
    const writeTrash = arr => { STATE.deletedGuides = arr || []; scheduleSaveRemote(); };

    const DEFAULT_ACTIVITIES = [
      'Credenciamento','Descredenciamento','1¬™ Venda (KYC)','Movimenta√ß√µes',
      'Investiga√ß√µes','Receb√≠veis','Disputa','Chargeback','Recupera√ß√£o','Cobran√ßa',
      'Processo de An√°lise','Monitoramentos','Alertas POS','Receb√≠veis (Fraude)',
      'Estruturas de dados','Modelagens e automa√ß√µes de processos'
    ];
    const readActs = () => {
      const saved = getSavedActs();
      const set = new Set([...DEFAULT_ACTIVITIES, ...saved]);
      return Array.from(set).sort((a,b)=>a.localeCompare(b,'pt-BR'));
    };

    function cleanupOrphanSubtitles(){
      const ids = new Set(readDB().map(g=>g.id));
      const subs = readSubs();
      let changed=false;
      Object.keys(subs).forEach(tid=>{
        const arr = subs[tid] || [];
        const blocked = new Set(['disputa - fluxo de checklist']);
        const filtered = arr.filter(s => {
          if (!s) return false;
          const t = String(s.title||'').trim().toLowerCase();
          if (blocked.has(t)) return false;
          return !s.guideId || ids.has(s.guideId);
        });
        if (filtered.length !== arr.length){ subs[tid]=filtered; changed=true; }
      });
      if (changed) writeSubs(subs);
    }

    /* ===== Favoritos (local) ===== */
    const FAV_KEY = 'or_help_favs_v1';
    const readFav = ()=>JSON.parse(localStorage.getItem(FAV_KEY)||'{"topics":[],"guides":[]}');
    const writeFav= v => localStorage.setItem(FAV_KEY, JSON.stringify(v));

    /* ===== Abas ===== */
    const tabsBtns = $$('[data-tab]');
    const tabsPanes = {
      content: $('#tab-content'),
      index:   $('#tab-index'),
      search:  $('#tab-search'),
      favs:    $('#tab-favs'),
      trash:   $('#tab-trash')
    };
    function setTab(name){
      tabsBtns.forEach(b=>b.classList.toggle('tab-on', b.dataset.tab===name));
      Object.entries(tabsPanes).forEach(([k,p])=>{
        if (p) p.classList.toggle('hidden', k!==name);
      });
      if (name==='favs')  renderFavs();
      if (name==='trash') renderTrash();
    }
    tabsBtns.forEach(b=>b.addEventListener('click',()=>setTab(b.dataset.tab)));
    setTab('content');

    /* ===== Accordion ===== */
    function initAccordion(){
      $$('[data-acc]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const key = btn.getAttribute('data-acc');
          const pane= $('#acc-'+key);
          const ic  = $('[data-acc-icon="'+key+'"]');
          const hidden = pane.classList.toggle('hidden');
          ic.textContent = hidden ? '‚ñ≤' : '‚ñº';
        });
      });
    }
    initAccordion();

    /* ===== Navega√ß√£o √çndice ===== */
    $$('[data-jump]').forEach(a=>{
      a.addEventListener('click', ()=>{
        currentTopic = a.getAttribute('data-jump');
        setTab('content');
        renderTopic();
      });
    });

    /* ===== T√≥pico atual ===== */
    let currentTopic='credenciamento';
    let editingId = null;

    const topicTitleEl = $('#topicTitle');
    const topicDescEl  = $('#topicDesc');
    const topicHtmlEl  = $('#topicHtml');
    const guidesTitleEl= $('#guidesTitle');
    const guidesEl     = $('#guides');
    const btnFav       = $('#btnFav');
    const btnAdd       = $('#btnAdd');

    function renderTopic(){
      const t = TOPICS[currentTopic] || {title:'T√≥pico',desc:''};
      topicTitleEl.textContent = t.title;
      topicDescEl.textContent  = t.desc || '';
      $$('.sidebar-item[data-topic]').forEach(a=>a.classList.toggle('active', a.dataset.topic===currentTopic));

      const fav = readFav();
      btnFav.textContent = fav.topics.includes(currentTopic)
        ? '‚òÖ Remover dos Favoritos'
        : '‚òÜ Favoritar t√≥pico';

      if (t.html){
        topicHtmlEl.innerHTML = t.html;
        topicHtmlEl.classList.remove('hidden');
        guidesTitleEl.classList.add('hidden');
        guidesEl.innerHTML = '';
        btnAdd.classList.add('hidden');

        if (currentTopic==='ausencias'){
          setTimeout(()=>{ try{ mountAbsencesUI(); }catch(e){ console.error(e);} }, 0);
        }
      } else {
        topicHtmlEl.classList.add('hidden');
        guidesTitleEl.classList.remove('hidden');
        btnAdd.classList.remove('hidden');
        renderGuides();
      }
    }

    $$('.sidebar-item[data-topic]').forEach(a=>{
      a.addEventListener('click', e=>{
        e.preventDefault();
        currentTopic = a.dataset.topic;
        setTab('content');
        renderTopic();
      });
    });

    btnFav.onclick = ()=>{
      const fav = readFav();
      const i = fav.topics.indexOf(currentTopic);
      if (i>=0) fav.topics.splice(i,1);
      else      fav.topics.push(currentTopic);
      writeFav(fav);
      renderTopic();
    };

    /* ===== Subt√≠tulos ===== */
    const subModal      = $('#subModal');
    const subTopicName  = $('#subTopicName');
    const subForm       = $('#subForm');
    const subList       = $('#subList');
    const btnAddSubRow  = $('#btnAddSubRow');
    const btnCloseSub   = $('#closeSub');

    function renderSubsInSidebar(){
      $$('[data-subs-for]').forEach(c=>{c.innerHTML='';});
      const subs = readSubs();
      Object.entries(subs).forEach(([topicId, arr])=>{
        const box = $('[data-subs-for="'+topicId+'"]');
        if (!box || !arr || !arr.length) return;
        arr.forEach((s,i)=>{
          const a = document.createElement('a');
          a.href='#';
          a.className='sidebar-item sub-link hover:bg-gray-50';
          a.textContent = (s.guideId?'‚Ü≥ ':'') + (i+1)+'. '+(s.title||'Sem t√≠tulo');
          a.onclick = function(e){
            e.preventDefault();
            currentTopic = topicId;
            setTab('content');
            renderTopic();
            if (s.guideId){
              setTimeout(()=>{focusGuide(s.guideId);},80);
            }
          };
          box.appendChild(a);
        });
      });
    }

    function addSubRow(title='', desc='', guideId=''){
      const guides = readDB().filter(g=>g.topicId===currentTopic);
      const options = ['<option value="">(sem v√≠nculo)</option>'].concat(
        guides.map(g=>'<option value="'+g.id+'" '+(g.id===guideId?'selected':'')+'>'+escapeHtml(g.title)+'</option>')
      ).join('');
      const row = document.createElement('div');
      row.className='border rounded-xl p-3 space-y-2';
      row.innerHTML =
        '<div class="grid sm:grid-cols-2 gap-3">'+
          '<div><label class="text-sm text-gray-600">T√≠tulo do subt√≠tulo</label><input class="w-full border rounded-lg px-3 py-2" value="'+escapeAttr(title||'')+'"></div>'+
          '<div><label class="text-sm text-gray-600">Aponta para (guia)</label><select class="w-full border rounded-lg px-3 py-2">'+options+'</select></div>'+
        '</div>'+
        '<div class="grid sm:grid-cols-2 gap-3">'+
          '<div><label class="text-sm text-gray-600">Descri√ß√£o (opcional)</label><textarea class="w-full border rounded-lg px-3 py-2" rows="2">'+escapeHtml(desc||'')+'</textarea></div>'+
          '<div class="flex items-end justify-end"><button type="button" class="btn btn-ghost text-red-600 border-red-200 hover:bg-red-50" data-remove>Remover</button></div>'+
        '</div>';
      row.querySelector('[data-remove]').onclick = ()=>row.remove();
      subList.appendChild(row);
    }

    function openSubEditor(){
      const t = TOPICS[currentTopic];
      if (!t || t.html) return;
      subTopicName.textContent = t.title;
      subList.innerHTML = '';
      const subs = readSubs()[currentTopic] || [];
      subs.forEach(s=>addSubRow(s.title,s.desc,s.guideId));
      if (!subs.length) addSubRow();
      openModal(subModal,true);
    }

    btnAddSubRow.onclick = ()=>addSubRow();
    btnCloseSub.onclick  = ()=>openModal(subModal,false);

    document.addEventListener('keydown', e=>{
      const tag = (e.target && e.target.tagName ? e.target.tagName.toLowerCase() : '');
      const isTyping = tag==='input' || tag==='textarea' || tag==='select' || e.target.isContentEditable;
      if (isTyping) return;
      if (e.key.toLowerCase()==='s' && !e.ctrlKey && !e.metaKey){
        e.preventDefault();
        openSubEditor();
      }
    });

    subForm.onsubmit = e=>{
      e.preventDefault();
      const arr=[];
      subList.querySelectorAll('div.border.rounded-xl').forEach(row=>{
        const title   = row.querySelector('input').value.trim();
        const desc    = row.querySelector('textarea').value.trim();
        const guideId = row.querySelector('select').value;
        if (title || desc || guideId) arr.push({title,desc,guideId});
      });
      const all = readSubs();
      all[currentTopic] = arr;
      writeSubs(all);
      openModal(subModal,false);
      renderSubsInSidebar();
    };

    /* ===== Guias ===== */
    function escapeHtml(str){ return String(str||'').replace(/[&<>"]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[s])); }
    function escapeAttr(str){ return escapeHtml(str).replace(/'/g,'&#39;'); }

    function getSubtitleForGuide(topicId, guideId){
      const arr = readSubs()[topicId] || [];
      const s = arr.find(x=>x.guideId===guideId);
      return s ? s.title : '';
    }

    function focusGuide(guideId){
      if (!guideId) return;
      const el = document.querySelector('[data-guide="'+guideId+'"]');
      if (!el) return;
      const body  = el.querySelector('[data-body]');
      const toggle= el.querySelector('[data-toggle]');
      if (body && body.classList.contains('hidden')){
        body.classList.remove('hidden');
        if (toggle){
          toggle.setAttribute('aria-expanded','true');
          toggle.textContent='‚ñæ';
        }
      }
      el.scrollIntoView({behavior:'smooth', block:'start'});
      const first = el.querySelector('details');
      if (first) first.open = true;
    }

    function deleteGuideById(guideId){
      const db = readDB();
      const idx = db.findIndex(x=>x.id===guideId);
      if (idx === -1) return;

      const g = db[idx];

      const deletedAt = nowFmt();
      const hist = Array.isArray(g.history) ? g.history.slice() : [];
      hist.push({ ts: deletedAt, author: g.author || '‚Äî', action: 'exclu√≠do' });

      const trashItem = { ...g, history: hist, deletedAt };
      const trash = readTrash();
      writeTrash([trashItem, ...trash]); // mais recente primeiro

      // remove o guia do DB
      db.splice(idx,1);
      writeDB(db);

      // remove v√≠nculos de subt√≠tulo:
      // 1) normal: subt√≠tulo vinculado por guideId
      // 2) fallback: se existir subt√≠tulo antigo sem guideId, remove pelo mesmo t√≠tulo do guia
      const subs = readSubs();
      const norm = v => String(v||'').trim().toLowerCase();
      const gTitleNorm = norm(g.title);

      Object.keys(subs).forEach(tid=>{
        subs[tid] = (subs[tid]||[]).filter(s=>{
          if (s && s.guideId === guideId) return false;
          if (s && !s.guideId && norm(s.title) === gTitleNorm) return false;
          return true;
        });
      });
      writeSubs(subs);

      // garante limpeza de qualquer outro ‚Äú√≥rf√£o‚Äù
      cleanupOrphanSubtitles();

      // remove de favoritos (local)
      const fav = readFav();
      fav.guides = (fav.guides||[]).filter(id=>id!==guideId);
      writeFav(fav);
    }

    function restoreGuideById(guideId){
      const trash = readTrash();
      const idx = trash.findIndex(x=>x.id===guideId);
      if (idx === -1) return;
      const item = trash[idx];

      const restoredAt = nowFmt();
      const hist = Array.isArray(item.history) ? item.history.slice() : [];
      hist.push({ ts: restoredAt, author: item.author || '‚Äî', action: 'restaurado' });

      const guide = { ...item, history: hist };
      delete guide.deletedAt;

      const db = readDB();
      db.unshift(guide);
      writeDB(db);

      trash.splice(idx,1);
      writeTrash(trash);
    }

    function renderGuides(){
      const guides = readDB().filter(g=>g.topicId===currentTopic);
      guidesEl.innerHTML='';
      if (!guides.length){
        guidesEl.innerHTML='<p class="text-gray-500">Nenhum guia cadastrado.</p>';
        return;
      }
      const fav = readFav();
      guides.forEach(g=>{
        const fOn = (fav.guides||[]).includes(g.id);
        const card = document.createElement('div');
        card.className='border rounded-xl p-4 card';
        card.setAttribute('data-guide',g.id);

        const subTitle = getSubtitleForGuide(g.topicId,g.id);
        const subBadge = subTitle
          ? '<span class="px-2 py-1 rounded-full text-xs bg-indigo-50 text-indigo-700 whitespace-nowrap">'+escapeHtml(subTitle)+'</span>'
          : '';

        card.innerHTML =
          '<div class="flex items-start justify-between gap-3">'+
            '<div class="min-w-0">'+
              '<div class="font-semibold truncate">'+escapeHtml(g.title)+'</div>'+
              '<div class="text-xs text-gray-500">Por '+escapeHtml(g.author||'-')+' ‚Äî '+escapeHtml(g.role||'-')+'</div>'+
              '<div class="text-xs text-gray-400">Atualizado em '+escapeHtml(g.updated||'-')+'</div>'+
            '</div>'+
            '<div class="flex items-center gap-2 shrink-0">'+
              subBadge+
              '<button class="btn btn-ghost" data-toggle aria-expanded="false" title="Mostrar passos">‚ñ∏</button>'+
              '<button class="btn btn-ghost" data-star title="Favoritar">'+(fOn?'‚òÖ':'‚òÜ')+'</button>'+
              '<button class="btn btn-ghost" data-history title="Ver hist√≥rico">Hist√≥rico</button>'+
              '<button class="btn btn-ghost" data-edit>Editar</button>'+
              '<button class="btn btn-danger" data-del>Excluir</button>'+
            '</div>'+
          '</div>'+
          '<div class="mt-2 hidden text-xs text-gray-600 space-y-0.5" data-history-body></div>'+
          '<div class="mt-3 space-y-3 hidden" data-body></div>';

        const body        = card.querySelector('[data-body]');
        const toggleBtn   = card.querySelector('[data-toggle]');
        const historyBtn  = card.querySelector('[data-history]');
        const historyBody = card.querySelector('[data-history-body]');

        historyBody.innerHTML = '';
        if (Array.isArray(g.history) && g.history.length){
          g.history.forEach(h=>{
            const line = document.createElement('div');
            line.textContent = (h.ts||'-')+' ‚Äî '+(h.author||'-')+' ‚Äî '+(h.action||'atualiza√ß√£o');
            historyBody.appendChild(line);
          });
        } else {
          const line = document.createElement('div');
          line.textContent = 'Sem hist√≥rico registrado.';
          historyBody.appendChild(line);
        }

        historyBtn.onclick = ()=>{
          const hidden = historyBody.classList.contains('hidden');
          historyBody.classList.toggle('hidden', !hidden);
          historyBtn.textContent = hidden ? 'Ocultar hist√≥rico' : 'Hist√≥rico';
        };

        toggleBtn.onclick = ()=>{
          const expanded = toggleBtn.getAttribute('aria-expanded')==='true';
          toggleBtn.setAttribute('aria-expanded', String(!expanded));
          toggleBtn.textContent = expanded ? '‚ñ∏' : '‚ñæ';
          body.classList.toggle('hidden', expanded);

          if (!expanded && !body.dataset.mounted){
            body.dataset.mounted='1';
            (g.steps||[]).forEach((s,i)=>{
              const det = document.createElement('details');
              det.className='rounded-xl border overflow-hidden';
              det.open = i===0;

              const descHtml = s.desc || '';
              let linksHtml = '';
              if (Array.isArray(s.links) && s.links.length){
                const items = s.links.map(u=>{
                  const safe = normalizeUrl(u);
                  return '<li><a class="text-indigo-700 hover:underline" href="'+safe+'" target="_blank" rel="noopener noreferrer">'+safe+'</a></li>';
                }).join('');
                linksHtml =
                  '<div class="pt-1"><div class="text-xs text-gray-500 mb-1">Links √∫teis</div><ul class="list-disc pl-6 text-sm">'+items+'</ul></div>';
              }

              det.innerHTML =
                '<summary class="cursor-pointer select-none flex items-center gap-2 px-3 py-2 bg-gray-50 text-gray-900">'+
                  '<span class="inline-flex items-center justify-center h-6 px-2 text-xs font-semibold rounded-full bg-gray-800 text-white">Passo '+(i+1)+'</span>'+
                  '<span class="font-medium">'+escapeHtml(s.title||'Sem t√≠tulo')+'</span>'+
                '</summary>'+
                '<div class="p-3 space-y-3">'+
                  (descHtml ? '<div class="prose prose-sm max-w-none">'+descHtml+'</div>' : '<div class="text-sm text-gray-500">Sem descri√ß√£o.</div>')+
                  linksHtml+
                '</div>';

              // Zoom: imagens dentro da descri√ß√£o (Quill)
              det.addEventListener('click', (ev)=>{
                const target = ev.target;
                if (target && target.tagName === 'IMG' && target.closest('.prose')){
                  ev.preventDefault();
                  $('#imgViewer').src = target.src;
                  openModal($('#imgModal'), true);
                }
              });

              body.appendChild(det);
            });
          }
        };

        card.querySelector('[data-edit]').onclick = ()=>openEditor(g.id);

        card.querySelector('[data-del]').onclick = (ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          if (confirm('Excluir este guia? Ele vai para a Lixeira (com hist√≥rico).')){
            deleteGuideById(g.id);
            renderTopic();
            renderSubsInSidebar();
          }
        };

        card.querySelector('[data-star]').onclick = ()=>{
          const fv = readFav();
          fv.guides = fv.guides || [];
          const idx = fv.guides.indexOf(g.id);
          if (idx>=0) fv.guides.splice(idx,1);
          else        fv.guides.push(g.id);
          writeFav(fv);
          renderGuides();
        };

        guidesEl.appendChild(card);
      });
    }

    /* ===== Modal Guia / Quill + IMAGEM NA DESCRI√á√ÉO ===== */
    const guideModal  = $('#guideModal');
    const imgModal    = $('#imgModal');
    const stepsWrap   = $('#stepsWrap');
    const btnAddStep  = $('#btnAddStep');
    const btnClose    = $('#closeGuide');
    const closeImg    = $('#closeImg');
    const btnDeleteGuide = $('#btnDeleteGuide');
    const form        = $('#guideForm');
    const modTitle    = $('#modalTitle');
    const createSub   = $('[name="create_sub"]');
    const subFields   = $('#subFields');
    const subTitleInput = $('[name="sub_title"]');
    const subDescInput  = $('[name="sub_desc"]');

    const fileToBase64 = f => new Promise((res,rej)=>{
      const r = new FileReader();
      r.onload = ()=>res(r.result);
      r.onerror= rej;
      r.readAsDataURL(f);
    });

    if (createSub){
      createSub.onchange = ()=>{
        subFields.classList.toggle('hidden', !createSub.checked);
        if (createSub.checked && subTitleInput){
          if (!subTitleInput.value || !subTitleInput.value.trim()){
            subTitleInput.value = form && form.title ? form.title.value : '';
          }
        }
      };
    }

    async function insertImageIntoQuill(quill){
      const useUpload = confirm('Quer enviar uma imagem do computador?\\n\\nOK = Enviar arquivo\\nCancelar = Colar URL');
      if (useUpload){
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async () => {
          const file = input.files && input.files[0];
          if (!file) return;
          const dataUrl = await fileToBase64(file);
          const range = quill.getSelection(true) || { index: quill.getLength() };
          quill.insertEmbed(range.index, 'image', dataUrl, 'user');
          quill.setSelection(range.index + 1, 0);
        };
        input.click();
        return;
      }

      const url = prompt('Cole a URL da imagem (https://...):');
      const safe = normalizeUrl(url || '');
      if (!safe || !/^https?:\/\//i.test(safe)) return;

      const range = quill.getSelection(true) || { index: quill.getLength() };
      quill.insertEmbed(range.index, 'image', safe, 'user');
      quill.setSelection(range.index + 1, 0);
    }

    function initQuill(holder, initialHtml){
      const wrap = document.createElement('div');
      wrap.className='quill-wrap';
      const tpl = document.getElementById('quill-toolbar-template');
      const toolbar = tpl.content.firstElementChild.cloneNode(true);
      const editor  = document.createElement('div');
      editor.className='quill-editor bg-white';
      wrap.appendChild(toolbar);
      wrap.appendChild(editor);

      const q = new Quill(editor,{ theme:'snow', modules:{ toolbar } });
      const tb = q.getModule('toolbar');
      tb.addHandler('image', () => insertImageIntoQuill(q));

      if (initialHtml) q.root.innerHTML = initialHtml;
      holder.appendChild(wrap);
      return q;
    }

    function addStep(title='', desc='', linksArr=[]){
      const d = document.createElement('div');
      d.className='border rounded-xl p-3 space-y-2';
      d.innerHTML =
        '<div class="grid sm:grid-cols-2 gap-3">'+
          '<div>'+
            '<label class="text-sm text-gray-600">T√≠tulo do passo</label>'+
            '<input class="w-full border rounded-lg px-3 py-2" name="st_title" value="'+escapeAttr(title||'')+'">'+
          '</div>'+
          '<div class="text-sm text-gray-500 flex items-end">'+
            '<span>üìå Imagens: use o bot√£o üñºÔ∏è na <b>Descri√ß√£o</b>.</span>'+
          '</div>'+
        '</div>'+
        '<div><label class="text-sm text-gray-600">Links √∫teis (um por linha)</label><textarea class="w-full border rounded-lg px-3 py-2" rows="3" name="st_links">'+(Array.isArray(linksArr)?escapeHtml(linksArr.join("\\n")):"")+'</textarea></div>'+
        '<div><label class="text-sm text-gray-600">Descri√ß√£o / instru√ß√µes</label><div data-quill-holder></div></div>'+
        '<div class="flex justify-end"><button type="button" class="btn btn-ghost text-red-600 border-red-200 hover:bg-red-50" name="st_remove">Remover passo</button></div>';

      d.querySelector('[name="st_remove"]').onclick = ()=>d.remove();
      const holder = d.querySelector('[data-quill-holder]');
      initQuill(holder, desc||'');
      stepsWrap.appendChild(d);
    }

    function openEditor(id=null){
      editingId = id;
      stepsWrap.innerHTML='';
      form.reset();
      form.updated.value = nowFmt();
      if (createSub){
        createSub.checked=false;
        subFields.classList.add('hidden');
      }
      if (subTitleInput) subTitleInput.value='';
      if (subDescInput)  subDescInput.value='';

      if (id){
        const g = readDB().find(x=>x.id===id);
        if (!g) return;
        modTitle.textContent='Editar guia';
        btnDeleteGuide.classList.remove('hidden');
        form.title.value   = g.title;
        form.author.value  = g.author;
        form.role.value    = g.role;
        form.updated.value = g.updated;

        // Carrega passos com HTML j√° salvo (inclui imagens)
        (g.steps||[]).forEach(st=> addStep(st.title||'', st.desc||'', st.links||[]) );
      } else {
        modTitle.textContent='Adicionar guia';
        btnDeleteGuide.classList.add('hidden');
        addStep();
        addStep();
      }
      openModal(guideModal,true);
    }

    $('#btnAdd').onclick = ()=>openEditor();
    btnAddStep.onclick   = ()=>addStep();
    btnClose.onclick     = ()=>openModal(guideModal,false);
    closeImg.onclick     = ()=>openModal(imgModal,false);
    imgModal.onclick     = e=>{ if (e.target===imgModal) openModal(imgModal,false); };

    form.onsubmit = e=>{
      e.preventDefault();
      const g = {
        id: editingId || uuid(),
        topicId: currentTopic,
        title:   form.title.value.trim(),
        author:  form.author.value.trim(),
        role:    form.role.value.trim(),
        updated: nowFmt(),
        steps:   [],
        history: []
      };

      const rows = $$('#stepsWrap>div');
      for (const row of rows){
        const descEditor = row.querySelector('.ql-editor');
        const linksInput = row.querySelector('[name="st_links"]');
        const title      = row.querySelector('[name="st_title"]').value.trim();
        const descHtml   = descEditor ? descEditor.innerHTML : '';
        const st = {
          title,
          desc: descHtml,           // ‚úÖ aqui ficam as imagens (data:... ou https://...)
          links: parseLinks(linksInput ? linksInput.value : '')
        };
        g.steps.push(st);
      }

      const db = readDB();
      const existingIdx = db.findIndex(x=>x.id===g.id);

      if (existingIdx >= 0){
        const old = db[existingIdx];
        const hist = Array.isArray(old.history) ? old.history.slice() : [];
        hist.push({ ts: g.updated, author: g.author || '‚Äî', action: 'atualizado' });
        g.history = hist;
        db[existingIdx] = g;
      } else {
        g.history = [{ ts: g.updated, author: g.author || '‚Äî', action: 'criado' }];
        db.unshift(g);
      }
      writeDB(db);

      if (createSub && createSub.checked){
        const subTitleVal = (subTitleInput && subTitleInput.value ? subTitleInput.value.trim() : '') || g.title;
        const all = readSubs();
        const arr = all[currentTopic] || [];
        arr.push({ title: subTitleVal, desc: (subDescInput&&subDescInput.value?subDescInput.value.trim():''),
          guideId: g.id });
        all[currentTopic] = arr;
        writeSubs(all);
        renderSubsInSidebar();
      }

      openModal(guideModal,false);
      renderTopic();
    };

    btnDeleteGuide.onclick = ()=>{
      if (!editingId) return;
      if (confirm('Excluir este guia? Ele vai para a Lixeira.')){
        deleteGuideById(editingId);
        openModal(guideModal,false);
        editingId=null;
        renderTopic();
        renderSubsInSidebar();
      }
    };

    /* ===== Pesquisar ===== */
    const qInput = $('#q');
    const doSearch = $('#doSearch');
    const searchRes = $('#searchRes');

    function stripHtml(html){
      const div = document.createElement('div');
      div.innerHTML = html || '';
      return (div.textContent || div.innerText || '').trim();
    }

    function runSearch(){
      const q = (qInput.value||'').trim().toLowerCase();
      if (!q){
        searchRes.innerHTML='<p class="text-gray-500">Digite algo para buscar.</p>';
        return;
      }

      const out = [];

      // T√≥picos
      Object.entries(TOPICS).forEach(([id,t])=>{
        const hay = (t.title+' '+(t.desc||'')+' '+(t.html?stripHtml(t.html):'')).toLowerCase();
        if (hay.includes(q)){
          out.push({type:'topic', id, title:t.title, desc:t.desc||''});
        }
      });

      // Guias
      readDB().forEach(g=>{
        const textSteps = (g.steps||[]).map(s=> (s.title||'')+' '+stripHtml(s.desc||'')+' '+(s.links||[]).join(' ')).join(' ');
        const hay = (g.title+' '+(g.author||'')+' '+(g.role||'')+' '+textSteps).toLowerCase();
        if (hay.includes(q)){
          out.push({type:'guide', id:g.id, topicId:g.topicId, title:g.title, desc:'T√≥pico: '+(TOPICS[g.topicId]?.title||g.topicId)});
        }
      });

      if (!out.length){
        searchRes.innerHTML='<p class="text-gray-500">Nada encontrado.</p>';
        return;
      }

      searchRes.innerHTML='';
      out.slice(0,50).forEach(item=>{
        const card = document.createElement('div');
        card.className='border rounded-xl p-4 card';
        card.innerHTML =
          '<div class="font-semibold">'+escapeHtml(item.title)+'</div>'+
          '<div class="text-sm text-gray-600">'+escapeHtml(item.desc||'')+'</div>'+
          '<div class="mt-2"><button class="btn btn-ghost">Abrir</button></div>';
        card.querySelector('button').onclick = ()=>{
          if (item.type==='topic'){
            currentTopic = item.id;
            setTab('content');
            renderTopic();
          } else {
            currentTopic = item.topicId;
            setTab('content');
            renderTopic();
            setTimeout(()=>focusGuide(item.id), 80);
          }
        };
        searchRes.appendChild(card);
      });
    }

    doSearch.onclick = runSearch;
    qInput.addEventListener('keydown', e=>{
      if (e.key==='Enter'){ e.preventDefault(); runSearch(); }
    });

    /* ===== Favoritos ===== */
    const favList = $('#favList');

    function renderFavs(){
      const fav = readFav();
      favList.innerHTML='';

      const topicCards = (fav.topics||[]).map(tid=>{
        const t = TOPICS[tid];
        if (!t) return null;
        const el = document.createElement('div');
        el.className='border rounded-xl p-4 card';
        el.innerHTML =
          '<div class="font-semibold">'+escapeHtml(t.title)+'</div>'+
          '<div class="text-sm text-gray-600">'+escapeHtml(t.desc||'')+'</div>'+
          '<div class="mt-2 flex gap-2">'+
            '<button class="btn btn-ghost" data-open>Abrir</button>'+
            '<button class="btn btn-danger" data-remove>Remover</button>'+
          '</div>';
        el.querySelector('[data-open]').onclick = ()=>{
          currentTopic = tid;
          setTab('content');
          renderTopic();
        };
        el.querySelector('[data-remove]').onclick = ()=>{
          const f = readFav();
          f.topics = (f.topics||[]).filter(x=>x!==tid);
          writeFav(f);
          renderFavs();
        };
        return el;
      }).filter(Boolean);

      const guideCards = (fav.guides||[]).map(gid=>{
        const g = readDB().find(x=>x.id===gid);
        if (!g) return null;
        const el = document.createElement('div');
        el.className='border rounded-xl p-4 card';
        el.innerHTML =
          '<div class="font-semibold">'+escapeHtml(g.title)+'</div>'+
          '<div class="text-sm text-gray-600">T√≥pico: '+escapeHtml(TOPICS[g.topicId]?.title||g.topicId)+'</div>'+
          '<div class="mt-2 flex gap-2">'+
            '<button class="btn btn-ghost" data-open>Abrir</button>'+
            '<button class="btn btn-danger" data-remove>Remover</button>'+
          '</div>';
        el.querySelector('[data-open]').onclick = ()=>{
          currentTopic = g.topicId;
          setTab('content');
          renderTopic();
          setTimeout(()=>focusGuide(gid), 80);
        };
        el.querySelector('[data-remove]').onclick = ()=>{
          const f = readFav();
          f.guides = (f.guides||[]).filter(x=>x!==gid);
          writeFav(f);
          renderFavs();
        };
        return el;
      }).filter(Boolean);

      if (!topicCards.length && !guideCards.length){
        favList.innerHTML='<p class="text-gray-500">Nenhum favorito ainda.</p>';
        return;
      }

      if (topicCards.length){
        const h = document.createElement('div');
        h.className='font-semibold';
        h.textContent='T√≥picos';
        favList.appendChild(h);
        topicCards.forEach(el=>favList.appendChild(el));
      }
      if (guideCards.length){
        const h = document.createElement('div');
        h.className='font-semibold mt-4';
        h.textContent='Guias';
        favList.appendChild(h);
        guideCards.forEach(el=>favList.appendChild(el));
      }
    }

    /* ===== Lixeira ===== */
    const trashList = $('#trashList');
    const btnPurgeTrash = $('#btnPurgeTrash');
    const btnRefreshTrash = $('#btnRefreshTrash');

    function renderTrash(){
      const trash = readTrash();
      trashList.innerHTML='';
      if (!trash.length){
        trashList.innerHTML='<p class="text-gray-500">Lixeira vazia.</p>';
        return;
      }
      trash.forEach(item=>{
        const el = document.createElement('div');
        el.className='border rounded-xl p-4 card';
        el.innerHTML =
          '<div class="flex items-start justify-between gap-3">'+
            '<div class="min-w-0">'+
              '<div class="font-semibold truncate">'+escapeHtml(item.title||'(sem t√≠tulo)')+'</div>'+
              '<div class="text-xs text-gray-500">T√≥pico: '+escapeHtml(TOPICS[item.topicId]?.title||item.topicId||'-')+'</div>'+
              '<div class="text-xs text-gray-400">Exclu√≠do em: '+escapeHtml(item.deletedAt||'-')+'</div>'+
            '</div>'+
            '<div class="flex gap-2 shrink-0">'+
              '<button class="btn btn-ghost" data-restore>Restaurar</button>'+
              '<button class="btn btn-danger" data-delete>Apagar</button>'+
            '</div>'+
          '</div>'+
          '<div class="mt-2 text-xs text-gray-600 space-y-0.5" data-hist></div>';

        const histBox = el.querySelector('[data-hist]');
        const hist = Array.isArray(item.history) ? item.history : [];
        if (hist.length){
          hist.slice(-6).reverse().forEach(h=>{
            const line = document.createElement('div');
            line.textContent = (h.ts||'-')+' ‚Äî '+(h.author||'-')+' ‚Äî '+(h.action||'');
            histBox.appendChild(line);
          });
        } else {
          histBox.textContent='Sem hist√≥rico.';
        }

        el.querySelector('[data-restore]').onclick = ()=>{
          restoreGuideById(item.id);
          renderTrash();
          renderSubsInSidebar();
        };
        el.querySelector('[data-delete]').onclick = ()=>{
          if (!confirm('Apagar de vez? Isso n√£o d√° para desfazer.')) return;
          const arr = readTrash().filter(x=>x.id!==item.id);
          writeTrash(arr);
          renderTrash();
        };

        trashList.appendChild(el);
      });
    }

    btnPurgeTrash.onclick = ()=>{
      if (!confirm('Esvaziar a lixeira? Isso apaga tudo de vez.')) return;
      writeTrash([]);
      renderTrash();
    };
    btnRefreshTrash.onclick = renderTrash;

    /* ===== Aus√™ncias & Backups ===== */
    function mountAbsencesUI(){
      const formAbs = $('#absForm');
      if (!formAbs) return;

      const inpP = $('#absPrincipal');
      const inpB = $('#absBackups');
      const inpS = $('#absStart');
      const inpE = $('#absEnd');
      const list = $('#absList');
      const btn  = $('#absSave');
      const btnCancel = $('#absCancelEdit');

      const actsWrap = $('#absActs');
      const inpNew   = $('#absNewAct');
      const btnAdd   = $('#absAddAct');
      const btnManage= $('#absManageAct');

      const actModal = $('#actModal');
      const actList  = $('#actList');
      const closeAct = $('#closeAct');

      let editingIndex = null;

      function renderActs(){
        const acts = readActs();
        actsWrap.innerHTML='';
        acts.forEach(act=>{
          const chip = document.createElement('label');
          chip.className='inline-flex items-center gap-2 px-3 py-1 border rounded-full text-sm cursor-pointer bg-white hover:bg-indigo-50';
          chip.innerHTML =
            '<input type="checkbox" class="h-4 w-4" data-act="'+escapeAttr(act)+'"><span>'+escapeHtml(act)+'</span>';
          actsWrap.appendChild(chip);
        });
      }

      function getSelectedActs(){
        return [...actsWrap.querySelectorAll('input[type="checkbox"]')]
          .filter(i=>i.checked)
          .map(i=>i.getAttribute('data-act'));
      }
      function setSelectedActs(arr){
        const set = new Set(arr||[]);
        actsWrap.querySelectorAll('input[type="checkbox"]').forEach(ch=>{
          ch.checked = set.has(ch.getAttribute('data-act'));
        });
      }

      function openActManager(){
        const allActs  = readActs();
        const defaults = new Set(DEFAULT_ACTIVITIES);
        actList.innerHTML='';
        allActs.forEach(act=>{
          const isDefault = defaults.has(act);
          const row = document.createElement('div');
          row.className='border rounded-lg p-2 flex items-center gap-2';
          row.innerHTML =
            '<input class="flex-1 border rounded px-2 py-1 '+(isDefault?'bg-gray-50':'')+'" '+(isDefault?'disabled':'')+' value="'+escapeAttr(act)+'">'+
            (isDefault
              ? '<span class="text-xs text-gray-500 px-2">üîí padr√£o</span>'
              : '<div class="flex gap-2"><button class="btn btn-ghost" data-save>Salvar</button><button class="btn btn-danger" data-del>Excluir</button></div>'
            );
          if (!isDefault){
            const input = row.querySelector('input');
            row.querySelector('[data-save]').onclick = ()=>{
              const newName = (input.value||'').trim();
              if (!newName){ input.focus(); return; }
              const exists = readActs().some(a=>a!==act && a.toLowerCase()===newName.toLowerCase());
              if (exists){ alert('J√° existe uma atividade com esse nome.'); return; }

              const currentSaved = getSavedActs();
              const idx = currentSaved.indexOf(act);
              if (idx>=0) currentSaved[idx]=newName;
              else currentSaved.push(newName);

              writeActs(currentSaved.filter((v,i,a)=>a.indexOf(v)===i));

              // atualiza registros antigos
              const regs = readAbs().map(r=>{
                const arr = (r.activities||[]).map(a=> a===act ? newName : a);
                return {...r, activities: arr};
              });
              writeAbs(regs);

              renderActs(); renderList(); openActManager();
            };
            row.querySelector('[data-del]').onclick = ()=>{
              if (!confirm('Excluir atividade "'+act+'"?')) return;
              const currentSaved = getSavedActs().filter(a=>a!==act);
              writeActs(currentSaved);

              const regs = readAbs().map(r=>{
                const arr = (r.activities||[]).filter(a=>a!==act);
                return {...r, activities: arr};
              });
              writeAbs(regs);

              renderActs(); renderList(); openActManager();
            };
          }
          actList.appendChild(row);
        });

        openModal(actModal,true);
      }

      closeAct.onclick = ()=>openModal(actModal,false);
      actModal.onclick = (e)=>{ if (e.target===actModal) openModal(actModal,false); };

      btnAdd.onclick = ()=>{
        const val = (inpNew.value||'').trim();
        if (!val){ inpNew.focus(); return; }
        const saved = getSavedActs();
        if (!saved.includes(val)){
          saved.push(val);
          writeActs(saved);
          renderActs();
        }
        // marca automaticamente
        const checkbox = [...actsWrap.querySelectorAll('input[type="checkbox"]')]
          .find(i=>i.getAttribute('data-act')===val);
        if (checkbox) checkbox.checked = true;
        inpNew.value='';
      };
      btnManage.onclick = openActManager;

      function resetFormAbs(){
        inpP.value=''; inpB.value=''; inpS.value=''; inpE.value='';
        setSelectedActs([]);
        editingIndex=null;
        btn.textContent='Salvar';
        btnCancel.classList.add('hidden');
      }

      function renderList(){
        const data = readAbs();
        list.innerHTML='';
        if (!data.length){
          list.innerHTML='<p class="text-gray-500">Nenhum registro cadastrado.</p>';
          return;
        }
        data.forEach((row,idx)=>{
          const card = document.createElement('div');
          card.className='border rounded-lg p-3 flex items-start justify-between gap-3';
          const tags = (row.activities||[])
            .map(a=>'<span class="px-2 py-0.5 rounded-full text-xs bg-indigo-50 text-indigo-700">'+escapeHtml(a)+'</span>')
            .join(' ');
          const period = (row.start||row.end)
            ? '<div class="text-xs text-gray-600 mt-1">Per√≠odo: '+escapeHtml(row.start||'‚Äî')+' a '+escapeHtml(row.end||'‚Äî')+'</div>'
            : '';
          card.innerHTML =
            '<div class="min-w-0">'+
              '<div class="font-medium truncate">'+escapeHtml(row.principal)+'</div>'+
              '<div class="text-sm text-gray-600 truncate">Backups: '+escapeHtml(row.backups||'-')+'</div>'+
              period+
              '<div class="mt-1 flex flex-wrap gap-1">'+(tags||'<span class="text-xs text-gray-400">Sem atividades</span>')+'</div>'+
              '<div class="text-xs text-gray-400 mt-1">Atualizado em '+escapeHtml(row.updated||'-')+'</div>'+
            '</div>'+
            '<div class="flex gap-2">'+
              '<button class="btn btn-ghost" data-edit>Editar</button>'+
              '<button class="btn btn-danger" data-del>Excluir</button>'+
            '</div>';

          card.querySelector('[data-del]').onclick = ()=>{
            const arr = readAbs();
            arr.splice(idx,1);
            writeAbs(arr);
            renderList();
            if (editingIndex===idx) resetFormAbs();
          };
          card.querySelector('[data-edit]').onclick = ()=>{
            const r = readAbs()[idx];
            inpP.value=r.principal||'';
            inpB.value=r.backups||'';
            inpS.value=r.start||'';
            inpE.value=r.end||'';
            setSelectedActs(r.activities||[]);
            editingIndex=idx;
            btn.textContent='Atualizar';
            btnCancel.classList.remove('hidden');
            window.scrollTo({top: formAbs.getBoundingClientRect().top + window.scrollY - 80, behavior:'smooth'});
          };

          list.appendChild(card);
        });
      }

      btnCancel.onclick = resetFormAbs;

      btn.onclick = e=>{
        e.preventDefault();
        const principal = (inpP.value||'').trim();
        const backups   = (inpB.value||'').trim();
        const start     = (inpS.value||'').trim();
        const end       = (inpE.value||'').trim();
        const activities= getSelectedActs();
        if (!principal){ inpP.focus(); return; }
        if (start && end && start > end){
          alert('Data inicial n√£o pode ser maior que a final.');
          return;
        }
        const arr = readAbs();
        const payload = {principal,backups,start,end,activities,updated:nowFmt()};
        if (editingIndex!==null) arr[editingIndex]=payload;
        else                     arr.unshift(payload);
        writeAbs(arr);
        resetFormAbs();
        renderList();
      };

      renderActs();
      renderList();
    }

    /* ===== Boot ===== */
    loadRemote();
    renderTopic();
    renderSubsInSidebar();
  </script>
</body>
</html>
