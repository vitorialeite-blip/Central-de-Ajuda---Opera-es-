<script>
  /* ===== Polyfills ===== */
  function uuid() {
    try {
      if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    } catch (e) {}
    return 'id-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
  }
  if (typeof window.CSS === 'undefined') window.CSS = {};
  if (typeof window.CSS.escape !== 'function') {
    window.CSS.escape = function (s) {
      return String(s).replace(/[^a-zA-Z0-9_\-]/g, '\\$&');
    };
  }

  /* ====== T√≥picos ====== */
  const TOPICS = {
    'intro-sobre': {
      title: 'Sobre esta central',
      desc: '',
      html: '<h2>Bem-vindo üëã</h2><p>Use <b>Favoritos</b> para marcar o que voc√™ consulta com frequ√™ncia.</p>'
    },
    'intro-visao': {
      title: 'Gest√£o de Opera√ß√µes e Risco ‚Äî vis√£o',
      desc: '',
      html: '<h2>Vis√£o concentrada</h2><p>Menu em √°rvore √† esquerda e leitura √† direita.</p>'
    },
    credenciamento: {
      title: 'Credenciamento',
      desc: 'Credenciamento ‚Äî Cria√ß√£o/ativa√ß√£o de conta, gateways, adquirentes, VP.'
    },
    descredenciamento: {
      title: 'Descredenciamento',
      desc: 'Encerramento/ajustes de contas e adequa√ß√µes.'
    },
    kyc: {
      title: '1¬™ Venda (KYC)',
      desc: 'An√°lise do modelo de neg√≥cio e risco.'
    },
    movimentacoes: {
      title: 'Movimenta√ß√µes',
      desc: 'Saque, antecipa√ß√µes e transfer√™ncias.'
    },
    investigacoes: {
      title: 'Investiga√ß√µes',
      desc: 'Monitoramento e abertura de investiga√ß√£o.'
    },
    recebiveis: {
      title: 'Receb√≠veis',
      desc: 'Parametriza√ß√£o e libera√ß√£o mediante evid√™ncias.'
    },
    disputa: {
      title: 'Disputa',
      desc: 'Bloqueio tempor√°rio e decis√£o por evid√™ncias.'
    },
    chargeback: {
      title: 'Chargeback',
      desc: 'Defesa junto √†s adquirentes.'
    },
    recuperacao: {
      title: 'Recupera√ß√£o',
      desc: 'Revers√µes e contato ativo.'
    },
    cobranca: {
      title: 'Cobran√ßa',
      desc: 'Gest√£o de saldo negativo.'
    },
    'proc-analise': {
      title: 'Processo de An√°lise',
      desc: 'Antifraude, manual e monitoramentos.'
    },
    monitoramentos: {
      title: 'Monitoramentos',
      desc: 'Alertas e anomalias.'
    },
    'alertas-pos': {
      title: 'Alertas POS',
      desc: 'Cen√°rios de risco e bloqueios.'
    },
    'fraude-recebiveis': {
      title: 'Receb√≠veis (Fraude)',
      desc: 'Bloqueio at√© comprova√ß√£o da venda.'
    },
    'ctrl-visao': {
      title: 'Controles & Processos ‚Äî Vis√£o',
      desc: 'Acompanhamento e indicadores.'
    },
    'estruturas-dados': {
      title: 'Estruturas de dados',
      desc: 'Dicion√°rios e schemas.'
    },
    'modelagens-automacoes': {
      title: 'Modelagens e automa√ß√µes de processos',
      desc: 'Fluxos e integra√ß√µes.'
    },

    /* === Aus√™ncias & Backups === */
    ausencias: {
      title: 'Aus√™ncias & Backups',
      desc: '',
      html: `
          <h2 class="text-lg font-semibold mb-2">Cadastro de Aus√™ncias & Backups</h2>
          <p class="text-gray-600 mb-3">Registre a pessoa principal, o(s) backup(s), atividades cobertas e o per√≠odo de aus√™ncia.</p>

          <form id="absForm" class="border rounded-xl p-4 space-y-4 bg-gray-50">
            <div class="grid sm:grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-gray-600">Pessoa principal</label>
                <input id="absPrincipal" class="w-full border rounded-lg px-3 py-2" placeholder="Ex.: Maria Silva" />
              </div>
              <div>
                <label class="text-sm text-gray-600">Backup(s)</label>
                <input id="absBackups" class="w-full border rounded-lg px-3 py-2" placeholder="Ex.: Jo√£o Souza; Ana Lima" />
              </div>
            </div>

            <div class="grid sm:grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-gray-600">In√≠cio</label>
                <input id="absStart" type="date" class="w-full border rounded-lg px-3 py-2"/>
              </div>
              <div>
                <label class="text-sm text-gray-600">Fim</label>
                <input id="absEnd" type="date" class="w-full border rounded-lg px-3 py-2"/>
              </div>
            </div>

            <div>
              <label class="text-sm text-gray-600">Atividades cobertas</label>
              <div id="absActs" class="flex flex-wrap gap-2 mt-2"></div>

              <div class="flex flex-wrap items-center gap-2 mt-3">
                <input id="absNewAct" class="flex-1 min-w-[240px] border rounded-lg px-3 py-2" placeholder="Adicionar atividade (ex.: Neoway)" />
                <button id="absAddAct" type="button" class="btn btn-ghost">+ Adicionar</button>
                <button id="absManageAct" type="button" class="btn btn-ghost">‚öôÔ∏è Gerenciar atividades</button>
              </div>
              <p class="text-xs text-gray-500 mt-1">Marque o que a pessoa principal faz e o backup tamb√©m consegue cobrir.</p>
            </div>

            <div class="flex justify-end gap-2">
              <button class="btn btn-ghost hidden" id="absCancelEdit" type="button">Cancelar edi√ß√£o</button>
              <button class="btn btn-primary" id="absSave">Salvar</button>
            </div>
          </form>

          <div class="mt-4">
            <h3 class="font-semibold mb-2">Registros</h3>
            <div id="absList" class="space-y-2"></div>
          </div>
        `
    }
  };

  /* ===== Helpers base ===== */
  const $ = (s, p = document) => p.querySelector(s);
  const $$ = (s, p = document) => [...p.querySelectorAll(s)];
  const nowFmt = () => new Date().toLocaleString('pt-BR');
  const openModal = (el, v) => {
    el.classList.toggle('hidden', !v);
    el.classList.toggle('flex', v);
  };

  const DB_KEY = 'or_help_guides_v4';
  const FAV_KEY = 'or_help_favs_v1';
  const SUB_KEY = 'or_help_subtitles_v1';
  const ABS_KEY = 'or_help_absences_v1';
  const ABS_ACTS_KEY = 'or_help_absences_acts_v1';

  // ‚ö†Ô∏è TROCAR pela URL real do seu Worker (Overview do central-ajuda-api)
  const API_BASE = 'https://central-ajuda-api.seuusuario.workers.dev';

  // ======== Fun√ß√µes para falar com o Worker / KV =========
  async function kvGet(key, fallback) {
    try {
      const res = await fetch(`${API_BASE}/store/${encodeURIComponent(key)}`);
      if (!res.ok) throw new Error('Status ' + res.status);
      const text = await res.text();
      if (!text) return fallback;
      return JSON.parse(text);
    } catch (e) {
      console.error('KV GET erro para', key, e);
      return fallback;
    }
  }

  async function kvPut(key, value) {
    try {
      await fetch(`${API_BASE}/store/${encodeURIComponent(key)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(value)
      });
    } catch (e) {
      console.error('KV PUT erro para', key, e);
    }
  }

  async function syncFromServer() {
    const [guides, favs, subs, abs, acts] = await Promise.all([
      kvGet(DB_KEY, null),
      kvGet(FAV_KEY, null),
      kvGet(SUB_KEY, null),
      kvGet(ABS_KEY, null),
      kvGet(ABS_ACTS_KEY, null)
    ]);

    if (guides) localStorage.setItem(DB_KEY, JSON.stringify(guides));
    if (favs) localStorage.setItem(FAV_KEY, JSON.stringify(favs));
    if (subs) localStorage.setItem(SUB_KEY, JSON.stringify(subs));
    if (abs) localStorage.setItem(ABS_KEY, JSON.stringify(abs));
    if (acts) localStorage.setItem(ABS_ACTS_KEY, JSON.stringify(acts));
  }

  function syncKeyToServer(key) {
    const raw = localStorage.getItem(key);
    if (raw === null) return;
    try {
      const json = JSON.parse(raw);
      kvPut(key, json);
    } catch (e) {
      console.error('Erro ao sincronizar chave', key, e);
    }
  }

  // ======== Fun√ß√µes de leitura/grava√ß√£o (localStorage + KV) =========
  const readDB = () => JSON.parse(localStorage.getItem(DB_KEY) || '[]');
  const writeDB = (a) => {
    localStorage.setItem(DB_KEY, JSON.stringify(a));
    syncKeyToServer(DB_KEY);
  };

  const readFav = () => JSON.parse(localStorage.getItem(FAV_KEY) || '{"topics":[],"guides":[]}');
  const writeFav = (v) => {
    localStorage.setItem(FAV_KEY, JSON.stringify(v));
    syncKeyToServer(FAV_KEY);
  };

  const readSubs = () => JSON.parse(localStorage.getItem(SUB_KEY) || '{}');
  const writeSubs = (v) => {
    localStorage.setItem(SUB_KEY, JSON.stringify(v));
    syncKeyToServer(SUB_KEY);
  };

  const readAbs = () => JSON.parse(localStorage.getItem(ABS_KEY) || '[]');
  const writeAbs = (v) => {
    localStorage.setItem(ABS_KEY, JSON.stringify(v));
    syncKeyToServer(ABS_KEY);
  };

  const fileToBase64 = (f) =>
    new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(f);
    });

  const DEFAULT_ACTIVITIES = [
    'Credenciamento', 'Descredenciamento', '1¬™ Venda (KYC)', 'Movimenta√ß√µes',
    'Investiga√ß√µes', 'Recebiveis', 'Receb√≠veis', 'Disputa', 'Chargeback', 'Recupera√ß√£o', 'Cobran√ßa',
    'Processo de An√°lise', 'Monitoramentos', 'Alertas POS', 'Receb√≠veis (Fraude)',
    'Estruturas de dados', 'Modelagens e automa√ß√µes de processos'
  ];

  const getSavedActs = () =>
    JSON.parse(localStorage.getItem(ABS_ACTS_KEY) || '[]');

  const writeActs = (arr) => {
    localStorage.setItem(ABS_ACTS_KEY, JSON.stringify(arr || []));
    syncKeyToServer(ABS_ACTS_KEY);
  };

  const readActs = () => {
    const saved = getSavedActs();
    const set = new Set([...DEFAULT_ACTIVITIES, ...saved]);
    return Array.from(set).sort((a, b) => a.localeCompare(b, 'pt-BR'));
  };

  function cleanupOrphanSubtitles() {
    const ids = new Set(readDB().map((g) => g.id));
    const subs = readSubs();
    let changed = false;
    Object.keys(subs).forEach((topicId) => {
      const arr = subs[topicId] || [];
      const filtered = arr.filter((s) => !s.guideId || ids.has(s.guideId));
      if (filtered.length !== arr.length) {
        subs[topicId] = filtered;
        changed = true;
      }
    });
    if (changed) writeSubs(subs);
  }

  let currentTopic = 'credenciamento';
  let editingId = null;

  /* ===== Abas ===== */
  const tabsBtns = $$('[data-tab]');
  const tabsPanes = {
    content: $('#tab-content'),
    index: $('#tab-index'),
    search: $('#tab-search'),
    favs: $('#tab-favs')
  };

  function setTab(name) {
    tabsBtns.forEach((b) => b.classList.toggle('tab-on', b.dataset.tab === name));
    Object.entries(tabsPanes).forEach(([k, p]) => {
      if (p) p.classList.toggle('hidden', k !== name);
    });
    if (name === 'favs') renderFavs();
  }
  tabsBtns.forEach((b) =>
    b.addEventListener('click', () => setTab(b.dataset.tab))
  );

  /* ===== Accordion ===== */
  function initAccordion() {
    $$('[data-acc]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const key = btn.getAttribute('data-acc');
        const pane = $('#acc-' + key);
        const ic = $('[data-acc-icon="' + key + '"]');
        const hidden = pane.classList.toggle('hidden');
        ic.textContent = hidden ? '‚ñ≤' : '‚ñº';
      });
    });
  }
  initAccordion();

  /* ===== T√≥pico/Gerais ===== */
  const topicTitleEl = $('#topicTitle'),
    topicDescEl = $('#topicDesc'),
    topicHtmlEl = $('#topicHtml');
  const guidesTitleEl = $('#guidesTitle'),
    guidesEl = $('#guides');
  const btnFav = $('#btnFav'),
    btnAdd = $('#btnAdd');

  function renderTopic() {
    const t = TOPICS[currentTopic] || { title: 'T√≥pico', desc: '' };
    topicTitleEl.textContent = t.title;
    topicDescEl.textContent = t.desc || '';
    $$('.sidebar-item').forEach((a) =>
      a.classList.toggle('active', a.dataset.topic === currentTopic)
    );
    const fav = readFav();
    btnFav.textContent = fav.topics.includes(currentTopic)
      ? '‚òÖ Remover dos Favoritos'
      : '‚òÜ Favoritar t√≥pico';

    if (t.html) {
      topicHtmlEl.innerHTML = t.html;
      topicHtmlEl.classList.remove('hidden');
      guidesTitleEl.classList.add('hidden');
      guidesEl.innerHTML = '';
      btnAdd.classList.add('hidden');

      if (currentTopic === 'ausencias') {
        try {
          mountAbsencesUI();
        } catch (e) {
          console.error('Aus√™ncias UI error:', e);
        }
      }
    } else {
      topicHtmlEl.classList.add('hidden');
      guidesTitleEl.classList.remove('hidden');
      btnAdd.classList.remove('hidden');
      renderGuides();
    }
  }

  $$('.sidebar-item[data-topic]').forEach((a) => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      currentTopic = a.dataset.topic;
      setTab('content');
      renderTopic();
    });
  });

  btnFav.onclick = () => {
    const fav = readFav();
    const i = fav.topics.indexOf(currentTopic);
    if (i >= 0) fav.topics.splice(i, 1);
    else fav.topics.push(currentTopic);
    writeFav(fav);
    renderTopic();
  };

  /* ===== Subt√≠tulos ===== */
  const subModal = $('#subModal'),
    subTopicName = $('#subTopicName'),
    subForm = $('#subForm'),
    subList = $('#subList');
  const btnAddSubRow = $('#btnAddSubRow'),
    btnCloseSub = $('#closeSub');

  function renderSubsInSidebar() {
    $$('[data-subs-for]').forEach((c) => {
      c.innerHTML = '';
    });
    const subs = readSubs();
    Object.entries(subs).forEach(([topicId, arr]) => {
      const box = $('[data-subs-for="' + topicId + '"]');
      if (!box || !arr || !arr.length) return;
      arr.forEach((s, i) => {
        const a = document.createElement('a');
        a.href = '#';
        a.className = 'sidebar-item sub-link hover:bg-gray-50';
        a.textContent =
          (s.guideId ? '‚Ü≥ ' : '') + (i + 1) + '. ' + (s.title || 'Sem t√≠tulo');
        a.onclick = function (e) {
          e.preventDefault();
          currentTopic = topicId;
          setTab('content');
          renderTopic();
          if (s.guideId) {
            setTimeout(function () {
              focusGuide(s.guideId);
            }, 80);
          }
        };
        box.appendChild(a);
      });
    });
  }

  function addSubRow(title = '', desc = '', guideId = '') {
    const guides = readDB().filter(function (g) {
      return g.topicId === currentTopic;
    });
    const options = ['<option value="">(sem v√≠nculo)</option>']
      .concat(
        guides.map(function (g) {
          return (
            '<option value="' +
            g.id +
            '" ' +
            (g.id === guideId ? 'selected' : '') +
            '>' +
            g.title +
            '</option>'
          );
        })
      )
      .join('');
    const row = document.createElement('div');
    row.className = 'border rounded-xl p-3 space-y-2';
    row.innerHTML =
      '<div class="grid sm:grid-cols-2 gap-3">' +
      '<div><label class="text-sm text-gray-600">T√≠tulo do subt√≠tulo</label><input class="w-full border rounded-lg px-3 py-2" value="' +
      (title || '') +
      '"></div>' +
      '<div><label class="text-sm text-gray-600">Aponta para (guia)</label><select class="w-full border rounded-lg px-3 py-2">' +
      options +
      '</select></div>' +
      '</div>' +
      '<div class="grid sm:grid-cols-2 gap-3">' +
      '<div><label class="text-sm text-gray-600">Descri√ß√£o (opcional)</label><textarea class="w-full border rounded-lg px-3 py-2" rows="2">' +
      (desc || '') +
      '</textarea></div>' +
      '<div class="flex items-end justify-end"><button type="button" class="btn btn-ghost text-red-600 border-red-200 hover:bg-red-50" data-remove>Remover</button></div>' +
      '</div>';
    row.querySelector('[data-remove]').onclick = function () {
      row.remove();
    };
    subList.appendChild(row);
  }

  function openSubEditor() {
    const t = TOPICS[currentTopic];
    if (!t || t.html) return;
    subTopicName.textContent = t.title;
    subList.innerHTML = '';
    const subs = readSubs()[currentTopic] || [];
    subs.forEach(function (s) {
      addSubRow(s.title, s.desc, s.guideId);
    });
    if (subs.length === 0) addSubRow();
    openModal(subModal, true);
  }
  btnAddSubRow.onclick = function () {
    addSubRow();
  };
  btnCloseSub.onclick = function () {
    openModal(subModal, false);
  };

  // Atalho S sem atrapalhar quando estiver digitando
  document.addEventListener('keydown', function (e) {
    const tag = e.target.tagName.toLowerCase();
    const isTypingElement =
      tag === 'input' ||
      tag === 'textarea' ||
      tag === 'select' ||
      e.target.isContentEditable;

    if (isTypingElement) return;

    if (e.key.toLowerCase() === 's' && !e.ctrlKey && !e.metaKey) {
      e.preventDefault();
      openSubEditor();
    }
  });

  subForm.onsubmit = function (e) {
    e.preventDefault();
    const arr = [];
    subList.querySelectorAll('div.border.rounded-xl').forEach(function (row) {
      const title = row.querySelector('input').value.trim();
      const desc = row.querySelector('textarea').value.trim();
      const guideId = row.querySelector('select').value;
      if (title || desc || guideId) {
        arr.push({ title: title, desc: desc, guideId: guideId });
      }
    });
    const all = readSubs();
    all[currentTopic] = arr;
    writeSubs(all);
    openModal(subModal, false);
    renderSubsInSidebar();
  };

  /* ===== Guias ===== */
  function getSubtitleForGuide(topicId, guideId) {
    const arr = readSubs()[topicId] || [];
    const s = arr.find(function (x) {
      return x.guideId === guideId;
    });
    return s ? s.title : '';
  }

  function focusGuide(guideId) {
    if (!guideId) return;
    const el = document.querySelector('[data-guide="' + guideId + '"]');
    if (!el) return;
    const body = el.querySelector('[data-body]');
    const toggle = el.querySelector('[data-toggle]');
    if (body && body.classList.contains('hidden')) {
      body.classList.remove('hidden');
      if (toggle) {
        toggle.setAttribute('aria-expanded', 'true');
        toggle.textContent = '‚ñæ';
      }
    }
    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    const first = el.querySelector('details');
    if (first) first.open = true;
  }

  function renderGuides() {
    const guides = readDB().filter(function (g) {
      return g.topicId === currentTopic;
    });
    guidesEl.innerHTML = '';
    if (!guides.length) {
      guidesEl.innerHTML =
        '<p class="text-gray-500">Nenhum guia cadastrado.</p>';
      return;
    }
    const fav = readFav();
    guides.forEach(function (g) {
      const fOn = (fav.guides || []).includes(g.id);
      const card = document.createElement('div');
      card.className = 'border rounded-xl p-4 card';
      card.setAttribute('data-guide', g.id);

      const subTitle = getSubtitleForGuide(g.topicId, g.id);
      const subBadge = subTitle
        ? '<span class="px-2 py-1 rounded-full text-xs bg-indigo-50 text-indigo-700 whitespace-nowrap">' +
          subTitle +
          '</span>'
        : '';
      card.innerHTML =
        '<div class="flex items-start justify-between gap-3">' +
        '<div class="min-w-0">' +
        '<div class="font-semibold truncate">' +
        g.title +
        '</div>' +
        '<div class="text-xs text-gray-500">Por ' +
        g.author +
        ' ‚Äî ' +
        (g.role || '-') +
        '</div>' +
        '<div class="text-xs text-gray-400">Atualizado em ' +
        g.updated +
        '</div>' +
        '</div>' +
        '<div class="flex items-center gap-2 shrink-0">' +
        subBadge +
        '<button class="btn btn-ghost" data-toggle aria-expanded="false" title="Mostrar passos">‚ñ∏</button>' +
        '<button class="btn btn-ghost" data-star title="Favoritar">' +
        (fOn ? '‚òÖ' : '‚òÜ') +
        '</button>' +
        '<button class="btn btn-ghost" data-edit>Editar</button>' +
        '<button class="btn btn-danger" data-del>Excluir</button>' +
        '</div>' +
        '</div>' +
        '<div class="mt-3 space-y-3 hidden" data-body></div>';

      const body = card.querySelector('[data-body]');
      const toggleBtn = card.querySelector('[data-toggle]');
      toggleBtn.onclick = function () {
        const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
        toggleBtn.setAttribute('aria-expanded', String(!expanded));
        toggleBtn.textContent = expanded ? '‚ñ∏' : '‚ñæ';
        body.classList.toggle('hidden', expanded);

        if (!expanded && !body.dataset.mounted) {
          body.dataset.mounted = '1';
          (g.steps || []).forEach(function (s, i) {
            const det = document.createElement('details');
            det.className = 'rounded-xl border overflow-hidden';
            det.open = i === 0;

            var linksHtml = '';
            if (Array.isArray(s.links) && s.links.length) {
              const items = s.links
                .map(function (u) {
                  const safe = normalizeUrl(u);
                  return (
                    '<li><a class="text-indigo-700 hover:underline" href="' +
                    safe +
                    '" target="_blank" rel="noopener noreferrer">' +
                    safe +
                    '</a></li>'
                  );
                })
                .join('');
              linksHtml =
                '<div class="pt-1"><div class="text-xs text-gray-500 mb-1">Links √∫teis</div><ul class="list-disc pl-6 text-sm">' +
                items +
                '</ul></div>';
            }

            var imgHtml = s.imgUrl
              ? '<img src="' +
                s.imgUrl +
                '" class="thumb w-full cursor-zoom-in rounded" alt="Passo ' +
                (i + 1) +
                '">'
              : '';
            var descHtml = s.desc
              ? '<div class="prose prose-sm max-w-none">' + s.desc + '</div>'
              : '';
            det.innerHTML =
              '<summary class="cursor-pointer select-none flex items-center gap-2 px-3 py-2 bg-gray-50 text-gray-900">' +
              '<span class="inline-flex items-center justify-center h-6 px-2 text-xs font-semibold rounded-full bg-gray-800 text-white">Passo ' +
              (i + 1) +
              '</span>' +
              '<span class="font-medium">' +
              (s.title || 'Sem t√≠tulo') +
              '</span>' +
              '</summary>' +
              '<div class="p-3 space-y-3">' +
              imgHtml +
              descHtml +
              linksHtml +
              '</div>';
            const img = det.querySelector('img');
            if (img) {
              img.onclick = function () {
                $('#imgViewer').src = s.imgUrl;
                openModal($('#imgModal'), true);
              };
            }
            body.appendChild(det);
          });
        }
      };

      card.querySelector('[data-edit]').onclick = function () {
        openEditor(g.id);
      };
      card.querySelector('[data-del]').onclick = function (ev) {
        ev.preventDefault();
        ev.stopPropagation();
        if (confirm('Excluir este guia?')) {
          const db = readDB().filter(function (x) {
            return x.id !== g.id;
          });
          writeDB(db);
          const subs = readSubs();
          Object.keys(subs).forEach(function (tid) {
            subs[tid] = (subs[tid] || []).filter(function (s) {
              return s.guideId !== g.id;
            });
          });
          writeSubs(subs);
          const fav = readFav();
          fav.guides = (fav.guides || []).filter(function (id) {
            return id !== g.id;
          });
          writeFav(fav);
          renderTopic();
          renderSubsInSidebar();
        }
      };
      card.querySelector('[data-star]').onclick = function () {
        const fv = readFav();
        fv.guides = fv.guides || [];
        const idx = fv.guides.indexOf(g.id);
        if (idx >= 0) fv.guides.splice(idx, 1);
        else fv.guides.push(g.id);
        writeFav(fv);
        renderGuides();
      };

      guidesEl.appendChild(card);
    });
  }

  /* ===== Modal Guia / Quill ===== */
  const guideModal = $('#guideModal'),
    imgModal = $('#imgModal'),
    stepsWrap = $('#stepsWrap');
  const btnAddStep = $('#btnAddStep'),
    btnClose = $('#closeGuide'),
    closeImg = $('#closeImg');
  const btnDeleteGuide = $('#btnDeleteGuide'),
    form = $('#guideForm'),
    modTitle = $('#modalTitle');
  const createSub = $('[name="create_sub"]'),
    subFields = $('#subFields'),
    subTitleInput = $('[name="sub_title"]'),
    subDescInput = $('[name="sub_desc"]');

  if (createSub) {
    createSub.onchange = function () {
      subFields.classList.toggle('hidden', !createSub.checked);
      if (createSub.checked && subTitleInput) {
        if (!subTitleInput.value || !subTitleInput.value.trim()) {
          subTitleInput.value = form && form.title ? form.title.value : '';
        }
      }
    };
  }

  function initQuill(holder, initialHtml) {
    const wrap = document.createElement('div');
    wrap.className = 'quill-wrap';
    const tpl = document.getElementById('quill-toolbar-template');
    const toolbar = tpl.content.firstElementChild.cloneNode(true);
    const editor = document.createElement('div');
    editor.className = 'quill-editor bg-white';
    wrap.appendChild(toolbar);
    wrap.appendChild(editor);
    const q = new Quill(editor, { theme: 'snow', modules: { toolbar: toolbar } });
    if (initialHtml) q.root.innerHTML = initialHtml;
    holder.appendChild(wrap);
    return q;
  }

  function addStep(title = '', desc = '', url = '', linksArr = []) {
    const d = document.createElement('div');
    d.className = 'border rounded-xl p-3 space-y-2';
    d.innerHTML =
      '<div class="grid sm:grid-cols-2 gap-3">' +
      '<div><label class="text-sm text-gray-600">T√≠tulo do passo</label><input class="w-full border rounded-lg px-3 py-2" name="st_title" value="' +
      (title || '') +
      '"></div>' +
      '<div><label class="text-sm text-gray-600">Imagem do passo</label><input type="file" accept="image/*" class="w-full border rounded-lg px-3 py-2" name="st_file"></div>' +
      '</div>' +
      '<div><label class="text-sm text-gray-600">URL da imagem</label><input class="w-full border rounded-lg px-3 py-2" name="st_url" value="' +
      (url || '') +
      '" placeholder="https://..."></div>' +
      '<div><label class="text-sm text-gray-600">Links √∫teis (um por linha)</label><textarea class="w-full border rounded-lg px-3 py-2" rows="3" name="st_links">' +
      (Array.isArray(linksArr) ? linksArr.join('\n') : '') +
      '</textarea></div>' +
      '<div><label class="text-sm text-gray-600">Descri√ß√£o / instru√ß√µes</label><div data-quill-holder></div></div>' +
      '<div class="flex justify-end"><button type="button" class="btn btn-ghost text-red-600 border-red-200 hover:bg-red-50" name="st_remove">Remover passo</button></div>';
    d.querySelector('[name="st_remove"]').onclick = function () {
      d.remove();
    };
    const holder = d.querySelector('[data-quill-holder]');
    initQuill(holder, desc || '');
    stepsWrap.appendChild(d);
  }

  function openEditor(id = null) {
    editingId = id;
    stepsWrap.innerHTML = '';
    form.reset();
    form.updated.value = nowFmt();
    if (createSub) {
      createSub.checked = false;
      subFields.classList.add('hidden');
    }
    if (subTitleInput) subTitleInput.value = '';
    if (subDescInput) subDescInput.value = '';
    if (id) {
      const g = readDB().find(function (x) {
        return x.id === id;
      });
      modTitle.textContent = 'Editar guia';
      btnDeleteGuide.classList.remove('hidden');
      form.title.value = g.title;
      form.author.value = g.author;
      form.role.value = g.role;
      form.updated.value = g.updated;
      (g.steps || []).forEach(function (st) {
        addStep(st.title, st.desc, st.imgUrl, st.links || []);
      });
    } else {
      modTitle.textContent = 'Adicionar guia';
      btnDeleteGuide.classList.add('hidden');
      addStep();
      addStep();
    }
    openModal(guideModal, true);
  }

  $('#btnAdd').onclick = function () {
    openEditor();
  };
  btnAddStep.onclick = function () {
    addStep();
  };
  btnClose.onclick = function () {
    openModal(guideModal, false);
  };
  closeImg.onclick = function () {
    openModal(imgModal, false);
  };
  imgModal.onclick = function (e) {
    if (e.target === imgModal) openModal(imgModal, false);
  };

  form.onsubmit = async function (e) {
    e.preventDefault();
    const g = {
      id: editingId || uuid(),
      topicId: currentTopic,
      title: form.title.value,
      author: form.author.value,
      role: form.role.value,
      updated: nowFmt(),
      steps: []
    };
    const rows = $$('#stepsWrap>div');
    for (const row of rows) {
      const descEditor = row.querySelector('.ql-editor');
      const st = {
        title: row.querySelector('[name="st_title"]').value,
        desc: descEditor ? descEditor.innerHTML : '',
        url: row.querySelector('[name="st_url"]').value
      };
      const file = row.querySelector('[name="st_file"]').files[0];
      st.imgUrl = file ? await fileToBase64(file) : st.url;
      st.links = parseLinks(row.querySelector('[name="st_links"]').value);
      g.steps.push(st);
    }
    const db = readDB();
    const i = db.findIndex(function (x) {
      return x.id === g.id;
    });
    if (i >= 0) db[i] = g;
    else db.unshift(g);
    writeDB(db);

    if (createSub && createSub.checked) {
      const subTitleVal =
        (subTitleInput && subTitleInput.value
          ? subTitleInput.value.trim()
          : '') || g.title;
      const all = readSubs();
      const arr = all[currentTopic] || [];
      arr.push({
        title: subTitleVal,
        desc:
          subDescInput && subDescInput.value
            ? subDescInput.value.trim()
            : '',
        guideId: g.id
      });
      all[currentTopic] = arr;
      writeSubs(all);
      renderSubsInSidebar();
    }
    openModal(guideModal, false);
    renderTopic();
  };

  btnDeleteGuide.onclick = function () {
    if (!editingId) return;
    if (confirm('Excluir este guia?')) {
      const db = readDB().filter(function (x) {
        return x.id !== editingId;
      });
      writeDB(db);
      const subs = readSubs();
      Object.keys(subs).forEach(function (tid) {
        subs[tid] = (subs[tid] || []).filter(function (s) {
          return s.guideId !== editingId;
        });
      });
      writeSubs(subs);
      const fav = readFav();
      fav.guides = (fav.guides || []).filter(function (id) {
        return id !== editingId;
      });
      writeFav(fav);
      openModal(guideModal, false);
      editingId = null;
      renderTopic();
      renderSubsInSidebar();
    }
  };

  const normalizeUrl = (u) => {
    u = (u || '').trim();
    if (!u) return '';
    if (!/^https?:\/\//i.test(u)) u = 'https://' + u;
    return u;
  };
  const parseLinks = (raw) =>
    (raw || '')
      .split(/\r?\n|,|;/)
      .map((v) => normalizeUrl(v))
      .filter((v) => v && /^https?:\/\//i.test(v));

  /* ===== Aus√™ncias & Backups (UI) ===== */
  function mountAbsencesUI() {
    const form = $('#absForm');
    const inpP = $('#absPrincipal');
    const inpB = $('#absBackups');
    const inpS = $('#absStart');
    const inpE = $('#absEnd');
    const list = $('#absList');
    const btn = $('#absSave');
    const btnCancel = $('#absCancelEdit');

    const actsWrap = $('#absActs');
    const inpNew = $('#absNewAct');
    const btnAdd = $('#absAddAct');
    const btnManage = $('#absManageAct');

    const actModal = $('#actModal');
    const actList = $('#actList');
    const closeAct = $('#closeAct');

    let editingIndex = null;

    function renderActs() {
      const acts = readActs();
      actsWrap.innerHTML = '';
      acts.forEach((act) => {
        const id = 'act_' + act.replace(/\s+/g, '_').toLowerCase();
        const chip = document.createElement('label');
        chip.className =
          'inline-flex items-center gap-2 px-3 py-1 border rounded-full text-sm cursor-pointer bg-white hover:bg-indigo-50';
        chip.innerHTML =
          '<input type="checkbox" class="h-4 w-4" data-act="' +
          act +
          '" id="' +
          id +
          '"><span>' +
          act +
          '</span>';
        actsWrap.appendChild(chip);
      });
    }
    function getSelectedActs() {
      return [...actsWrap.querySelectorAll('input[type="checkbox"]')]
        .filter((i) => i.checked)
        .map((i) => i.getAttribute('data-act'));
    }
    function setSelectedActs(arr) {
      const set = new Set(arr || []);
      actsWrap.querySelectorAll('input[type="checkbox"]').forEach((ch) => {
        ch.checked = set.has(ch.getAttribute('data-act'));
      });
    }

    btnAdd.onclick = () => {
      const val = (inpNew.value || '').trim();
      if (!val) {
        inpNew.focus();
        return;
      }
      const saved = getSavedActs();
      if (!saved.includes(val)) {
        saved.push(val);
        writeActs(saved);
        renderActs();
      }
      const input = actsWrap.querySelector(
        'input[data-act="' + CSS.escape(val) + '"]'
      );
      if (input) input.checked = true;
      inpNew.value = '';
    };

    function resetForm() {
      inpP.value = '';
      inpB.value = '';
      inpS.value = '';
      inpE.value = '';
      setSelectedActs([]);
      editingIndex = null;
      btn.textContent = 'Salvar';
      btnCancel.classList.add('hidden');
    }

    function renderList() {
      const data = readAbs();
      list.innerHTML = '';
      if (!data.length) {
        list.innerHTML =
          '<p class="text-gray-500">Nenhum registro cadastrado.</p>';
        return;
      }
      data.forEach((row, idx) => {
        const card = document.createElement('div');
        card.className =
          'border rounded-lg p-3 flex items-start justify-between gap-3';
        const tags = (row.activities || [])
          .map(
            (a) =>
              '<span class="px-2 py-0.5 rounded-full text-xs bg-indigo-50 text-indigo-700">' +
              a +
              '</span>'
          )
          .join(' ');
        const period =
          row.start || row.end
            ? '<div class="text-xs text-gray-600 mt-1">Per√≠odo: ' +
              (row.start || '‚Äî') +
              ' a ' +
              (row.end || '‚Äî') +
              '</div>'
            : '';
        card.innerHTML =
          '<div class="min-w-0">' +
          '<div class="font-medium truncate">' +
          row.principal +
          '</div>' +
          '<div class="text-sm text-gray-600 truncate">Backups: ' +
          (row.backups || '-') +
          '</div>' +
          period +
          '<div class="mt-1 flex flex-wrap gap-1">' +
          (tags ||
            '<span class="text-xs text-gray-400">Sem atividades</span>') +
          '</div>' +
          '<div class="text-xs text-gray-400 mt-1">Atualizado em ' +
          row.updated +
          '</div>' +
          '</div>' +
          '<div class="flex gap-2">' +
          '<button class="btn btn-ghost" data-edit>Editar</button>' +
          '<button class="btn btn-danger" data-del>Excluir</button>' +
          '</div>';

        card.querySelector('[data-del]').onclick = () => {
          const arr = readAbs();
          arr.splice(idx, 1);
          writeAbs(arr);
          renderList();
          if (editingIndex === idx) resetForm();
        };
        card.querySelector('[data-edit]').onclick = () => {
          const r = readAbs()[idx];
          inpP.value = r.principal || '';
          inpB.value = r.backups || '';
          inpS.value = r.start || '';
          inpE.value = r.end || '';
          setSelectedActs(r.activities || []);
          editingIndex = idx;
          btn.textContent = 'Atualizar';
          btnCancel.classList.remove('hidden');
          window.scrollTo({
            top: form.getBoundingClientRect().top + window.scrollY - 80,
            behavior: 'smooth'
          });
        };
        list.appendChild(card);
      });
    }

    btnCancel.onclick = resetForm;

    btn.onclick = (e) => {
      e.preventDefault();
      const principal = (inpP.value || '').trim();
      const backups = (inpB.value || '').trim();
      const start = (inpS.value || '').trim();
      const end = (inpE.value || '').trim();
      const activities = getSelectedActs();
      if (!principal) {
        inpP.focus();
        return;
      }
      if (start && end && start > end) {
        alert('Data inicial n√£o pode ser maior que a final.');
        return;
      }
      const arr = readAbs();
      const payload = {
        principal,
        backups,
        start,
        end,
        activities,
        updated: nowFmt()
      };
      if (editingIndex !== null) {
        arr[editingIndex] = payload;
      } else {
        arr.unshift(payload);
      }
      writeAbs(arr);
      resetForm();
      renderList();
    };

    function openActManager() {
      const allActs = readActs();
      const defaults = new Set(DEFAULT_ACTIVITIES);
      actList.innerHTML = '';
      allActs.forEach((act) => {
        const isDefault = defaults.has(act);
        const row = document.createElement('div');
        row.className = 'border rounded-lg p-2 flex items-center gap-2';
        row.innerHTML =
          '<input class="flex-1 border rounded px-2 py-1 ' +
          (isDefault ? 'bg-gray-50' : '') +
          '" ' +
          (isDefault ? 'disabled' : '') +
          ' value="' +
          act +
          '">' +
          (isDefault
            ? '<span class="text-xs text-gray-500 px-2">üîí padr√£o</span>'
            : '<div class="flex gap-2"><button class="btn btn-ghost" data-save>Salvar</button><button class="btn btn-danger" data-del>Excluir</button></div>');
        if (!isDefault) {
          const input = row.querySelector('input');
          row.querySelector('[data-save]').onclick = () => {
            const newName = (input.value || '').trim();
            if (!newName) {
              input.focus();
              return;
            }
            const exists = readActs().some(
              (a) => a !== act && a.toLowerCase() === newName.toLowerCase()
            );
            if (exists) {
              alert('J√° existe uma atividade com esse nome.');
              return;
            }
            const currentSaved = getSavedActs();
            const idx = currentSaved.indexOf(act);
            if (idx >= 0) {
              currentSaved[idx] = newName;
              writeActs(currentSaved);
            }
            const regs = readAbs().map((r) => {
              const arr = (r.activities || []).map((a) =>
                a === act ? newName : a
              );
              return { ...r, activities: arr };
            });
            writeAbs(regs);
            renderActs();
            renderList();
            openActManager();
          };
          row.querySelector('[data-del]').onclick = () => {
            if (
              !confirm(
                'Remover esta atividade? Ela tamb√©m ser√° removida dos registros.'
              )
            )
              return;
            const currentSaved = getSavedActs().filter((a) => a !== act);
            writeActs(currentSaved);
            const regs = readAbs().map((r) => {
              const arr = (r.activities || []).filter((a) => a !== act);
              return { ...r, activities: arr };
            });
            writeAbs(regs);
            renderActs();
            renderList();
            openActManager();
          };
        }
        actList.appendChild(row);
      });
      openModal(actModal, true);
    }
    btnManage.onclick = openActManager;
    closeAct.onclick = () => openModal(actModal, false);
    actModal.onclick = (e) => {
      if (e.target === actModal) openModal(actModal, false);
    };

    renderActs();
    renderList();
  }

  /* ===== Busca / Favoritos ===== */
  function search(q) {
    q = q.trim().toLowerCase();
    const out = [];
    Object.entries(TOPICS).forEach(function ([id, t]) {
      if (
        (t.title || '').toLowerCase().includes(q) ||
        (t.desc || '').toLowerCase().includes(q)
      ) {
        out.push({
          type: 'topic',
          id: id,
          title: t.title,
          desc: t.desc
        });
      }
    });
    readDB().forEach(function (g) {
      if (g.title.toLowerCase().includes(q)) {
        out.push({
          type: 'guide',
          id: g.id,
          topicId: g.topicId,
          title: g.title,
          desc: 'Guia em ' + (TOPICS[g.topicId]?.title || g.topicId)
        });
      }
    });
    return out;
  }

  const qInput = $('#q');
  const searchWrap = $('#searchRes');

  function renderSearchResults() {
    const q = qInput.value;
    const res = search(q);
    const wrap = searchWrap;
    wrap.innerHTML = '';

    if (!q.trim()) {
      wrap.innerHTML = '<p class="text-gray-500">Digite algo para pesquisar.</p>';
      return;
    }
    if (!res.length) {
      wrap.innerHTML = '<p class="text-gray-500">Nada encontrado.</p>';
      return;
    }

    res.forEach(function (r) {
      const d = document.createElement('div');
      d.className = 'border rounded-lg p-3';
      d.innerHTML =
        '<div class="text-sm ' +
        (r.type === 'topic' ? 'text-indigo-600' : 'text-green-700') +
        '">' +
        (r.type === 'topic' ? 'T√≥pico' : 'Guia') +
        '</div>' +
        '<div class="font-semibold">' +
        r.title +
        '</div>' +
        '<div class="text-gray-600 text-sm">' +
        (r.desc || '') +
        '</div>' +
        '<div class="mt-2"><button class="btn btn-ghost" data-open>Abrir</button></div>';

      d.querySelector('[data-open]').onclick = function () {
        if (r.type === 'topic') {
          currentTopic = r.id;
          setTab('content');
          renderTopic();
        } else {
          currentTopic = r.topicId;
          setTab('content');
          renderTopic();
          focusGuide(r.id);
        }
      };
      wrap.appendChild(d);
    });
  }

  $('#doSearch').onclick = function () {
    renderSearchResults();
  };

  qInput.addEventListener('input', function () {
    renderSearchResults();
  });

  qInput.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      renderSearchResults();
    }
  });

  function renderFavs() {
    const fav = readFav();
    const wrap = $('#favList');
    wrap.innerHTML = '';
    if (!fav.topics.length && !fav.guides.length) {
      wrap.innerHTML =
        '<p class="text-gray-500">Voc√™ ainda n√£o adicionou favoritos.</p>';
      return;
    }
    if (fav.topics.length) {
      const box = document.createElement('div');
      box.className = 'border rounded-xl p-4';
      box.innerHTML = '<div class="font-semibold mb-2">T√≥picos</div>';
      fav.topics.forEach(function (id) {
        const t = TOPICS[id];
        if (!t) return;
        const a = document.createElement('a');
        a.href = '#';
        a.className = 'block link hover:underline';
        a.textContent = t.title;
        a.onclick = function (e) {
          e.preventDefault();
          currentTopic = id;
          setTab('content');
          renderTopic();
        };
        box.appendChild(a);
      });
      wrap.appendChild(box);
    }
    if (fav.guides.length) {
      const box = document.createElement('div');
      box.className = 'border rounded-xl p-4';
      box.innerHTML = '<div class="font-semibold mb-2">Guias</div>';
      fav.guides.forEach(function (id) {
        const g = readDB().find(function (x) {
          return x.id === id;
        });
        if (!g) return;
        const btn = document.createElement('button');
        btn.className =
          'block link hover:underline text-left';
        btn.textContent =
          g.title + ' ‚Äî ' + (TOPICS[g.topicId]?.title || g.topicId);
        btn.onclick = function () {
          currentTopic = g.topicId;
          setTab('content');
          renderTopic();
          focusGuide(g.id);
        };
        box.appendChild(btn);
      });
      wrap.appendChild(box);
    }
  }

  // ========= Bootstrap: carrega KV e depois monta tela =========
  async function bootstrap() {
    await syncFromServer();      // puxa dados compartilhados
    cleanupOrphanSubtitles();    // limpa subt√≠tulos quebrados
    setTab('content');           // seleciona aba "Conte√∫do"
    renderSubsInSidebar();       // mostra subt√≠tulos
    renderTopic();               // mostra o t√≥pico atual
  }

  bootstrap();
</script>
